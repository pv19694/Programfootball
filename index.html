<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• Jakhong</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  @layer components {
    .input { @apply w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                   focus:outline-none focus:ring-2 focus:ring-slate-400; }
    .lbl   { @apply block mb-1 text-sm font-medium text-slate-700; }

    .btn   { @apply inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm font-medium
                     border transition shadow-sm hover:shadow active:scale-[.99]; }
    .btn-green { @apply bg-emerald-500 text-white border-transparent hover:bg-emerald-600; }  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤ */
    .btn-white { @apply bg-white text-slate-700 border-slate-300 hover:bg-slate-50; }         /* ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î */
    .btn-red   { @apply bg-rose-500 text-white border-transparent hover:bg-rose-600; }         /* ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡∏£‡∏π‡∏õ */

    .btn-ghost { @apply bg-white text-slate-700 border-slate-300 hover:bg-slate-50; }          /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢ ‡πÜ */
    .chip      { @apply inline-flex items-center rounded-full bg-slate-100 text-slate-700
                         px-2 py-0.5 text-[11px] font-medium; }
    .avatar { @apply w-40 h-40 md:w-56 md:h-56 rounded-2xl bg-slate-100 grid place-items-center text-3xl overflow-hidden; }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
  }
    :root{ color-scheme:light; --team-color:#16a34a; --team-contrast:#ffffff }
    body{font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .page{display:none}.page.active{display:block}
    .btn{border-radius:.9rem;padding:.55rem .9rem;font-weight:700;cursor:pointer}
    .btn-main{background:#0ea5e9;color:#fff;box-shadow:0 8px 18px rgba(14,165,233,.25)}
    .btn-s{background:#3b82f6;color:#fff;border-radius:.9rem;padding:.5rem .9rem}
    .btn-danger{background:#ef4444;color:#fff;border-radius:.9rem;padding:.5rem .9rem}
    .inp,.sel{width:100%;padding:.7rem;border:2px solid #e5e7eb;border-radius:.9rem;background:#fff}
    .inp:focus,.sel:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px rgba(147,197,253,.3)}
    .card{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem;text-align:center}
    .card .t{font-size:.85rem;color:#64748b}
    .card .v{font-size:1.5rem;font-weight:800;color:#2563eb}
    .panel{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem}
    table th,table td{padding:.5rem;text-align:center}
    /* player card */
    .player-card{position:relative;background:#fff;border-radius:1.1rem;border:1px solid rgba(2,6,23,.06);
      padding:.85rem;display:flex;gap:.8rem;align-items:center;
      box-shadow:0 18px 30px rgba(2,6,23,.06),0 2px 6px rgba(2,6,23,.04),inset 0 1px 0 rgba(255,255,255,.9)}
    .player-card:hover{transform:translateY(-2px);transition:.2s ease;box-shadow:0 22px 36px rgba(2,6,23,.10),0 4px 10px rgba(2,6,23,.06)}
    .player-avatar { width: 72px; height: 72px; border-radius: 6px;overflow: hidden;border: 2px solid #e5e7eb;box-shadow: 0 2px 6px rgba(0,0,0,.06);background: #fff;}
    .num-badge{position:absolute;left:44px;top:-6px;transform:translateX(-50%);
      background:var(--team-color);color:var(--team-contrast);font-weight:800;
      border-radius:999px;padding:.18rem .5rem;font-size:.7rem;box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .chip{border:1px solid rgba(2,6,23,.08);background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));
      border-radius:999px;padding:.1rem .5rem;font-size:.72rem}
    .team-header{background:var(--team-color);color:var(--team-contrast);border-radius:1rem;
      padding:.9rem 1rem;box-shadow:inset 0 -2px 0 rgba(255,255,255,.25),0 10px 24px rgba(0,0,0,.08)}
    /* ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠) */
.num-badge-static{background: var(--team-color);color: var(--team-contrast);font-weight: 700;border-radius: 999px;padding: 0.1rem 0.5rem;font-size: 0.7rem;line-height: 1;white-space: nowrap;box-shadow: 0 4px 10px rgba(0,0,0,.12);}
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

  <!-- Header -->
<header class="bg-white/90 backdrop-blur shadow sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
    
    <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ -->
    <div class="flex items-center gap-3 text-xl md:text-2xl font-bold text-gray-800">
      <img src="https://img5.pic.in.th/file/secure-sv1/S__2703408.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ Jakhong" class="h-10 w-10">
      <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ö‡∏≠‡∏•‡∏™‡∏ô‡∏≤‡∏° Jakhong</span>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="flex gap-2">
      <button id="btnClear" class="btn-danger">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
</header>

  <!-- Nav actions -->
<!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π -->
<nav class="container mx-auto px-4 py-3">
  <div class="flex flex-wrap items-center gap-3 justify-center md:justify-start">

    <button onclick="showPage('home')" 
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </button>

    <button onclick="showPage('score')"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </button>

    <button onclick="showPage('match')"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      ‚öΩ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
    </button>

    <button onclick="showPage('players')"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      üë§ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
    </button>

    <button onclick="showPage('teams')"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°
    </button>

    <button onclick="showPage('list')"
      class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold tracking-wide text-gray-700
      bg-white shadow-md transition-all duration-300
      hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md
      border border-transparent"
      style="border-image: linear-gradient(90deg, #ec4899, #8b5cf6, #3b82f6) 1;">
      üìù ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤
    </button>

  </div>
</nav>

<!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ -->
<!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ -->
<main class="container mx-auto px-4 py-6">
  <section id="home" class="page active">
    <h2 class="text-xl font-bold mb-2">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2>
    <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ö‡∏≠‡∏•‡∏™‡∏ô‡∏≤‡∏° Jakhong</p>
  </section>

  <section id="score" class="page">
    <h2 class="text-xl font-bold mb-2">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
    <p>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶</p>
  </section>

  <section id="match" class="page">
    <h2 class="text-xl font-bold mb-2">‚öΩ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</h2>
    <p>‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‚Ä¶</p>
  </section>

  <section id="players" class="page">
    <h2 class="text-xl font-bold mb-2">üë§ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
    <p>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Ä¶</p>
  </section>

  <section id="teams" class="page">
    <h2 class="text-xl font-bold mb-2">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</h2>
    <p>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‚Ä¶</p>
  </section>

  <section id="list" class="page">
    <h2 class="text-xl font-bold mb-2">üìù ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</h2>
    <p>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°‚Ä¶</p>
  </section>
</main>

<!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ + ‡∏ó‡∏≥ active ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° -->
<script>
  // ‡∏õ‡∏¥‡∏î‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° submit ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.querySelectorAll('nav button').forEach(btn => btn.type = 'button');

  function setActiveButton(targetId) {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('ring-2','ring-offset-2','ring-purple-400'));
    const btn = document.querySelector(`nav button[onclick*="${targetId}"]`);
    if (btn) btn.classList.add('ring-2','ring-offset-2','ring-purple-400'); // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  }

  function showPage(id) {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('active');
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï hash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
      if (location.hash !== '#' + id) history.replaceState(null, '', '#' + id);
      setActiveButton(id);
      // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ä‡∏±‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ header sticky)
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö hash ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô .../#players)
  window.addEventListener('DOMContentLoaded', () => {
    const initial = (location.hash || '#home').replace('#','');
    showPage(initial);
  });
</script>

<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS animation -->
<style>
@keyframes gradient-x {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.animate-gradient-x {
  background-size: 200% 200%;
  animation: gradient-x 3s ease infinite;
}
</style>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Dashboard -->
    <section id="dashboard" class="page active">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card"><div class="t">‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statTeams" class="v"></div></div>
        <div class="card"><div class="t">‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statMatches" class="v"></div></div>
        <div class="card"><div class="t">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statMembers" class="v"></div></div>
        <div class="card"><div class="t">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div id="statWeek" class="v"></div></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">ü•á Top Teams</h3>
        <div id="topTeams" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">üóìÔ∏è ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="recentMatches" class="space-y-2"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">üìä ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="activities" class="space-y-2 max-h-64 overflow-y-auto" aria-live="polite"></div>
      </div>
    </section>
    <!-- Table -->
    <section id="table" class="page">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 text-center text-xl font-bold">JAKHONG LEAGUE</div>
        <div class="p-3 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-700 text-white">
              <tr><th>#</th><th class="text-left">‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>+/-</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏ü‡∏≠‡∏£‡πå‡∏°</th></tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Match -->
    <section id="match" class="page">
      <div class="bg-white rounded-2xl shadow p-5 max-w-3xl mx-auto space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="lbl">‡∏ó‡∏µ‡∏° 1</label><select id="selHome" class="sel"></select></div>
          <div><label class="lbl">‡∏ó‡∏µ‡∏° 2</label><select id="selAway" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="lbl">‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡∏° 1</label><input id="hg" type="number" min="0" max="20" value="0" class="inp text-center"></div>
          <div><label class="lbl">‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡∏° 2</label><input id="ag" type="number" min="0" max="20" value="0" class="inp text-center"></div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
          <button id="saveMatch" class="btn-main">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
          <button id="incH" class="btn-s">üüß +1 ‡∏ó‡∏µ‡∏° 1</button>
          <button id="incA" class="btn-s">üü™ +1 ‡∏ó‡∏µ‡∏° 2</button>
          <button id="setDraw" class="btn-s">‚öñÔ∏è ‡πÄ‡∏™‡∏°‡∏≠</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏°‡∏ï‡∏ä‡πå</h3>
        <div id="matchLog" class="space-y-2 max-h-80 overflow-y-auto"></div>
      </div>
    </section>

    <!-- Players -->
    <section id="players" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <h3 class="text-center font-bold text-gray-800 mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div><label class="lbl">‡∏ó‡∏µ‡∏°</label><select id="selTeamForPlayer" class="sel"></select></div>
          <div><label class="lbl">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label><select id="selPlayer" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <button data-s="goals" class="btn-stat btn-s">‚öΩ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π</button>
          <button data-s="saves" class="btn-stat btn-s">ü•Ö ‡πÄ‡∏ã‡∏ü</button>
          <button data-s="yellowCards" class="btn-stat btn-s">üü® ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</button>
          <button data-s="redCards" class="btn-stat btn-s">üü• ‡πÅ‡∏î‡∏á</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
        <div class="panel"><h4>üèÜ ‡∏î‡∏≤‡∏ß‡∏ã‡∏±‡∏•‡πÇ‡∏ß</h4><div id="topGoals"></div></div>
        <div class="panel"><h4>üéØ ‡πÅ‡∏≠‡∏™‡∏ã‡∏¥‡∏™‡∏ï‡πå</h4><div id="topAssists"></div></div>
        <div class="panel"><h4>ü•Ö ‡∏Ñ‡∏•‡∏µ‡∏ô‡∏ä‡∏µ‡∏ó</h4><div id="topCS"></div></div>
      </div>
    </section>

    <!-- Teams -->
    <section id="teams" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div><label class="lbl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</label><select id="selEditTeam" class="sel"></select></div>
          <div><label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label><input id="inpTeamName" class="inp" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°"></div>
          <div>
            <label class="lbl">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡∏°</label>
            <div class="flex items-center gap-3">
              <div id="teamLogoPreviewEdit" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">üè≥Ô∏è</div>
              <input id="teamLogoInputEdit" type="file" accept="image/*" class="hidden">
              <button id="btnChooseTeamLogoEdit" class="btn-s">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
              <button id="btnClearTeamLogoEdit" class="btn-danger">üßπ ‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnTeamUpdate" class="btn-main">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button id="btnTeamAdd" class="btn-s">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnTeamDelete" class="btn-danger">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡∏°</button>
        </div>
      </div>
    </section>
        <!-- Roster -->
    <section id="roster" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
       
        <div class="flex items-center gap-2">
          <span class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°:</span>
          <select id="selRosterTeam" class="sel w-56"></select>
        </div>
        <div class="flex items-center gap-3">
          <input id="teamColor" type="color" value="#16a34a" class="w-10 h-8 p-0 border rounded-lg">
         
          <button id="btnToggleAddPlayer"
  class="relative inline-flex items-center gap-2 rounded-full px-5 py-2 font-semibold text-black bg-white overflow-hidden">
  <span class="relative z-10 text-xl font-bold">Ôºã</span>
  <span class="relative z-10">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</span>
  <span class="absolute inset-0 rounded-full p-[2px] bg-gradient-to-r from-pink-500 via-yellow-400 to-cyan-500 animate-[gradient-move_3s_linear_infinite]"></span>
  <span class="absolute inset-[2px] rounded-full bg-white"></span>
</button>

        </div>
      </div>

<div id="addPlayerForm" class="bg-white rounded-2xl shadow p-5 mb-5 hidden">
  <h3 class="text-center font-bold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
    <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ -->
    <div class="flex flex-col items-center gap-3">
      <div id="preview" class="avatar">üë§</div>
      <input id="npPhoto" type="file" accept="image/*" class="hidden">
      <div class="flex gap-2">
        <button id="btnPickPhoto"  type="button" class="btn btn-ghost">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
        <button id="btnClearPhoto" type="button" class="btn btn-red">üßπ ‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
      </div>
    </div>

    <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô) -->
    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤ (‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° options ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) -->
      <div class="md:col-span-2">
        <label class="lbl" for="npTeam">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°</label>
        <select id="npTeam" class="input">
          <!-- renderTeamSelects() ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° option ‡πÉ‡∏´‡πâ -->
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="lbl" for="npName">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</label>
        <input id="npName" name="name" type="text" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∏‡πÄ‡∏°‡∏ò ‡∏®‡∏∏‡∏†‡∏Å‡∏¥‡∏à">
      </div>

      <div>
        <label class="lbl" for="npNum">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label>
        <input id="npNum" name="num" type="number" class="input" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10">
      </div>

      <div>
        <label class="lbl" for="npPos">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <select id="npPos" name="pos" class="input">
          <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äî</option>
          <option value="GK">GK ‚Äî ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
          <option value="DF">DF ‚Äî ‡∏Å‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</option>
          <option value="MF">MF ‚Äî ‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</option>
          <option value="FW">FW ‚Äî ‡∏Å‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
        </select>
      </div>

      <div>
        <label class="lbl" for="npAge">‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <input id="npAge" name="age" type="number" class="input" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 24">
      </div>

      <div>
        <label class="lbl" for="npBirth">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
        <input id="npBirth" name="birth" type="date" class="input">
      </div>

      <div class="md:col-span-2 flex flex-wrap items-center gap-2 pt-2">
        <button id="btnAddNewPlayer"    type="button" class="btn btn-green">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
        <button id="btnClearNewPlayer"  type="button" class="btn btn-white">üßΩ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        <button id="btnDownloadRoster"  type="button" class="btn btn-white">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="btnCancelNewPlayer" type="button" class="btn btn-red">‚úñÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>
</div>


      <div class="team-header mb-4"><h2 class="font-bold text-xl">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°: <span id="rosterTeamName">-</span></h2></div>
      <div id="rosterGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <!-- Script -->
  <script>
    const STORAGE_KEY='football_state_ce_v2';
    const $=(s,r=document)=>r.querySelector(s);
    const esc=s=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    let state={teams:[],matches:[],playersStats:[]};
    function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
    function load(){try{state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{teams:[],matches:[],playersStats:[]}}catch{state={teams:[],matches:[],playersStats:[]}}}

    function calcAgeFromISO(iso){if(!iso)return'';const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}
    // ====== ID helper ======
    const nid = p=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;

    // ====== Activities log ======
    function log(msg){
      const box = $('#activities');
      if(!box) return;
      const line = document.createElement('div');
      line.className = 'text-sm text-slate-700';
      const ts = new Date().toLocaleString();
      line.textContent = `‚Ä¢ [${ts}] ${msg}`;
      box.prepend(line);
      // limit 100
      while(box.children.length>100) box.removeChild(box.lastChild);
    }

    // ====== Tabs ======
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const p = btn.getAttribute('data-p');
        document.querySelectorAll('.page').forEach(s=>s.classList.remove('active'));
        document.getElementById(p).classList.add('active');
      });
    });

    // ====== Team selects rendering ======
    function renderTeamSelects(){
      const opts = state.teams.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');
      if($('#selEditTeam')) $('#selEditTeam').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>'+opts;
      if($('#selHome'))     $('#selHome').innerHTML     = opts;
      if($('#selAway'))     $('#selAway').innerHTML     = opts;
      if($('#selTeamForPlayer')) $('#selTeamForPlayer').innerHTML = opts;
      if($('#selRosterTeam'))    $('#selRosterTeam').innerHTML    = opts;
      if($('#npTeam'))           $('#npTeam').innerHTML           = opts;
    }

    // ====== Standings from matches ======
    function computeTable(){
      const tmap = {};
      state.teams.forEach(t=>{
        tmap[t.id] = { id:t.id, name:t.name, logo:t.logo||'', P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0, form:[] };
      });
      state.matches.forEach(m=>{
        const H = tmap[m.homeId], A = tmap[m.awayId];
        if(!H||!A) return;
        H.P++; A.P++;
        H.GF+=m.hg; H.GA+=m.ag; H.GD=H.GF-H.GA;
        A.GF+=m.ag; A.GA+=m.hg; A.GD=A.GF-A.GA;

        if(m.hg>m.ag){ H.W++; A.L++; H.PTS+=3; H.form.push('W'); A.form.push('L'); }
        else if(m.hg<m.ag){ A.W++; H.L++; A.PTS+=3; A.form.push('W'); H.form.push('L'); }
        else { H.D++; A.D++; H.PTS+=1; A.PTS+=1; H.form.push('D'); A.form.push('D'); }
      });
      const arr = Object.values(tmap).sort((a,b)=> b.PTS-a.PTS || b.GD-a.GD || b.GF-a.GF || a.name.localeCompare(b.name));
      return arr;
    }

    function renderTable(){
      const rows = computeTable().map((r,i)=>{
        const last5 = r.form.slice(-5).join(' ');
        return `<tr class="odd:bg-white even:bg-slate-50">
          <td class="font-bold">${i+1}</td>
          <td class="text-left"><div class="flex items-center gap-2">
            ${r.logo?`<img src="${r.logo}" class="w-6 h-6 rounded-full object-cover border">`:'<span>üè≥Ô∏è</span>'}
            <span>${esc(r.name)}</span></div></td>
          <td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td>
          <td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td><td class="font-bold">${r.PTS}</td>
          <td class="text-xs">${last5}</td></tr>`;
      }).join('');
      if($('#tbl')) $('#tbl').innerHTML = rows || `<tr><td colspan="11" class="py-6 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    // ====== Dashboard ======
    function renderDashboard(){
      const teams = state.teams.length;
      const matches = state.matches.length;
      const members = state.teams.reduce((s,t)=> s + (t.members?.length||0), 0);
      if($('#statTeams'))   $('#statTeams').textContent = teams;
      if($('#statMatches')) $('#statMatches').textContent = matches;
      if($('#statMembers')) $('#statMembers').textContent = members;
      if($('#statWeek'))    $('#statWeek').textContent = 1;

      // Top Teams (top 3)
      const table = computeTable();
      if($('#topTeams')){
        $('#topTeams').innerHTML = table.slice(0,3).map((r,i)=>`
          <div class="panel text-left flex items-center gap-3">
            <div class="text-2xl font-black text-sky-600">${i+1}</div>
            ${r.logo?`<img src="${r.logo}" class="w-10 h-10 rounded-full object-cover border">`:'<div class="w-10 h-10 rounded-full grid place-items-center bg-slate-100">üè≥Ô∏è</div>'}
            <div>
              <div class="font-bold">${esc(r.name)}</div>
              <div class="text-xs text-slate-500">Pts ${r.PTS} ‚Ä¢ GD ${r.GD}</div>
            </div>
          </div>`).join('') || `<div class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
      }

      // Recent Matches
      if($('#recentMatches')){
        const rec = [...state.matches].slice(-6).reverse().map(m=>{
          const h = state.teams.find(t=>t.id===m.homeId)?.name||'‚Äî';
          const a = state.teams.find(t=>t.id===m.awayId)?.name||'‚Äî';
          return `<div class="flex justify-between items-center text-sm">
            <span>${esc(h)} vs ${esc(a)}</span>
            <span class="font-bold">${m.hg} : ${m.ag}</span>
          </div>`;
        }).join('');
        $('#recentMatches').innerHTML = rec || `<div class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå</div>`;
      }
    }

    // ====== Match ======
    function renderMatchLog(){
      if(!$('#matchLog')) return;
      const html = [...state.matches].reverse().map(m=>{
        const h = state.teams.find(t=>t.id===m.homeId)?.name||'‚Äî';
        const a = state.teams.find(t=>t.id===m.awayId)?.name||'‚Äî';
        const ts = new Date(m.date||Date.now()).toLocaleString();
        return `<div class="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2">
          <span class="text-sm">${esc(h)} vs ${esc(a)} ‚Ä¢ <span class="font-bold">${m.hg}:${m.ag}</span></span>
          <span class="text-xs text-slate-500">${ts}</span>
        </div>`;
      }).join('');
      $('#matchLog').innerHTML = html || `<div class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
    }

    $('#incH')?.addEventListener('click', ()=> { const el=$('#hg'); el.value = (+el.value||0)+1; });
    $('#incA')?.addEventListener('click', ()=> { const el=$('#ag'); el.value = (+el.value||0)+1; });
    $('#setDraw')?.addEventListener('click', ()=> { $('#hg').value = 1; $('#ag').value = 1; });

    $('#saveMatch')?.addEventListener('click', ()=>{
      const homeId = $('#selHome').value, awayId = $('#selAway').value;
      const hg = +$('#hg').value||0, ag = +$('#ag').value||0;
      if(!homeId||!awayId||homeId===awayId) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤/‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      const m = { id:nid('m'), homeId, awayId, hg, ag, date: Date.now() };
      state.matches.push(m);
      save();
      renderTable(); renderDashboard(); renderMatchLog();
      log(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• ${state.teams.find(t=>t.id===homeId)?.name} ${hg}:${ag} ${state.teams.find(t=>t.id===awayId)?.name}`);
      $('#hg').value = 0; $('#ag').value = 0;
    });

    // ====== Players stats ======
    // playersStats: [{playerId, name, teamId, goals, assists, saves, cleanSheets, yellowCards, redCards}]
    function ensurePlayerStat(playerId, name, teamId){
      let s = state.playersStats.find(x=>x.playerId===playerId);
      if(!s){ s = { playerId, name, teamId, goals:0, assists:0, saves:0, cleanSheets:0, yellowCards:0, redCards:0 }; state.playersStats.push(s); }
      return s;
    }

    function renderPlayerDropdowns(){
      const teamId = $('#selTeamForPlayer').value || state.teams[0]?.id || '';
      const team = state.teams.find(t=>t.id===teamId);
      if(!team) { $('#selPlayer').innerHTML=''; return; }
      $('#selPlayer').innerHTML = (team.members||[]).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
    }

    document.querySelectorAll('.btn-stat').forEach(b=>{
      b.addEventListener('click', ()=>{
        const teamId = $('#selTeamForPlayer').value;
        const pid = $('#selPlayer').value;
        if(!teamId||!pid) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô');
        const player = state.teams.find(t=>t.id===teamId)?.members?.find(m=>m.id===pid);
        if(!player) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô');
        const key = b.getAttribute('data-s'); // goals, assists, ...
        const stat = ensurePlayerStat(pid, player.name, teamId);
        stat[key] = (stat[key]||0)+1;
        save(); renderTopStats();
        log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ${player.name}: ${key}+1`);
      });
    });

    function topList(key){
      // aggregate by player across teams
      const arr = [...state.playersStats].sort((a,b)=> (b[key]||0)-(a[key]||0) ).slice(0,10);
      return arr.map((s,i)=>{
        const tname = state.teams.find(t=>t.id===s.teamId)?.name||'-';
        return `<div class="flex justify-between items-center py-1 ${i%2?'':'bg-slate-50'} rounded px-2">
          <span class="text-sm">${i+1}. ${esc(s.name)} <span class="text-xs text-slate-500">(${esc(tname)})</span></span>
          <span class="font-bold">${s[key]||0}</span>
        </div>`;
      }).join('') || `<div class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    }
    function renderTopStats(){
      if($('#topGoals'))   $('#topGoals').innerHTML   = topList('goals');
      if($('#topAssists')) $('#topAssists').innerHTML = topList('assists');
      if($('#topCS'))      $('#topCS').innerHTML      = topList('cleanSheets');
    }

    $('#selTeamForPlayer')?.addEventListener('change', renderPlayerDropdowns);

    // ====== Teams (logo upload + CRUD) ======
    function renderTeamEditPreview(team){
      const box = $('#teamLogoPreviewEdit');
      if(!box) return;
      if(team?.logo){ box.innerHTML = `<img src="${team.logo}" class="w-full h-full object-cover" alt="${esc(team.name)}">`; }
      else { box.innerHTML = `üè≥Ô∏è`; }
    }

    let pendingLogoDataURL_Edit = '';
    $('#btnChooseTeamLogoEdit')?.addEventListener('click', ()=> $('#teamLogoInputEdit').click());
    $('#btnClearTeamLogoEdit')?.addEventListener('click', ()=>{ pendingLogoDataURL_Edit=''; renderTeamEditPreview(null); $('#teamLogoInputEdit').value=''; });

    $('#teamLogoInputEdit')?.addEventListener('change', e=>{
      const f = e.target.files?.[0]; if(!f) return;
      if(!f.type.startsWith('image/')) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); e.target.value=''; return; }
      if(f.size > 5*1024*1024) { alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); e.target.value=''; return; }
      const r = new FileReader();
      r.onload = ev => { pendingLogoDataURL_Edit = ev.target.result; $('#teamLogoPreviewEdit').innerHTML = `<img src="${pendingLogoDataURL_Edit}" class="w-full h-full object-cover">`; };
      r.readAsDataURL(f);
    });

    $('#btnTeamAdd')?.addEventListener('click', ()=>{
      const name = $('#inpTeamName').value.trim();
      if(!name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°');
      if(state.teams.some(t=>t.name===name)) return alert('‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
      state.teams.push({ id:nid('team'), name, logo: pendingLogoDataURL_Edit || '', members:[] });
      save();
      $('#inpTeamName').value=''; pendingLogoDataURL_Edit=''; $('#teamLogoInputEdit').value='';
      renderTeamSelects(); renderTeamEditPreview(null); renderDashboard(); renderTable(); renderRosterHooks();
      log(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà: ${name}`);
    });

    $('#btnTeamUpdate')?.addEventListener('click', ()=>{
      const id = $('#selEditTeam').value;
      const name = $('#inpTeamName').value.trim();
      if(!id) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°'); if(!name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°');
      const t = state.teams.find(x=>x.id===id); if(!t) return;
      t.name = name; if(pendingLogoDataURL_Edit) t.logo = pendingLogoDataURL_Edit;
      save();
      renderTeamSelects(); $('#selEditTeam').value = t.id; renderTeamEditPreview(t);
      pendingLogoDataURL_Edit=''; $('#teamLogoInputEdit').value='';
      renderDashboard(); renderTable(); renderRosterHooks();
      log(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏°: ${name}`);
    });

    $('#btnTeamDelete')?.addEventListener('click', ()=>{
      const id = $('#selEditTeam').value; if(!id) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°');
      const t = state.teams.find(x=>x.id===id); if(!t) return;
      if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏µ‡∏° "${t.name}" ?`)) return;
      state.teams = state.teams.filter(x=>x.id!==id);
      // remove matches involving that team
      state.matches = state.matches.filter(m=> m.homeId!==id && m.awayId!==id );
      save();
      $('#inpTeamName').value=''; pendingLogoDataURL_Edit=''; $('#teamLogoInputEdit').value='';
      renderTeamSelects(); renderTeamEditPreview(null); renderDashboard(); renderTable(); renderMatchLog(); renderRosterHooks();
      log(`‡∏•‡∏ö‡∏ó‡∏µ‡∏°: ${t.name}`);
    });

    $('#selEditTeam')?.addEventListener('change', e=>{
      const t = state.teams.find(x=>x.id===e.target.value);
      $('#inpTeamName').value = t?.name || '';
      pendingLogoDataURL_Edit=''; renderTeamEditPreview(t||null); $('#teamLogoInputEdit').value='';
    });

    // ====== Roster (upload + add + grid + theme) ======
    let tempPlayerPhoto='';
    $('#btnPickPhoto')?.addEventListener('click', ()=> $('#npPhoto').click());
    $('#btnClearPhoto')?.addEventListener('click', ()=>{ tempPlayerPhoto=''; $('#preview').innerHTML='üë§'; $('#npPhoto').value=''; });

    $('#npPhoto')?.addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      if(!f.type.startsWith('image/')){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); e.target.value=''; return; }
      if(f.size>5*1024*1024){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); e.target.value=''; return; }
      const r=new FileReader(); r.onload=ev=>{ tempPlayerPhoto=ev.target.result; $('#preview').innerHTML=`<img src="${tempPlayerPhoto}" class="w-full h-full object-cover">`; }; r.readAsDataURL(f);
    });

    $('#npBirth')?.addEventListener('input', ()=>{ const iso=$('#npBirth').value; const a=calcAgeFromISO(iso); if(a||a===0) $('#npAge').value=a; });

    function labelPos(pos){ return pos==='goalkeeper'? '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π' : pos==='defender'? '‡∏Å‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á' : pos==='midfielder'? '‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á' : '‡∏Å‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤'; }

    function renderRosterGrid(){
      const teamId=$('#selRosterTeam').value;
      const team=state.teams.find(t=>t.id===teamId);
      if($('#rosterTeamName')) $('#rosterTeamName').textContent = team?.name || '-';
      const grid=$('#rosterGrid');
      const items = (team?.members || []).map(p => `
  <div class="player-card">
    <div class="relative">
      <img src="${p.photo || ''}" alt="${esc(p.name)}" class="player-avatar object-cover">
    </div>
    <div class="min-w-0 flex-1">
      <!-- ‡∏ä‡∏∑‡πà‡∏≠ + ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠ (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) -->
      <div class="flex items-start justify-between gap-2">
        <div class="font-bold whitespace-normal break-words leading-tight">
  ${esc(p.name)}
</div>
        <span class="num-badge-static">#${p.num || '-'}</span>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡∏≠‡∏≤‡∏¢‡∏∏ / ‡∏ß/‡∏î/‡∏õ ‡πÄ‡∏Å‡∏¥‡∏î -->
      <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-600">
  <span class="chip">${labelPos(p.pos)}</span>
  <span class="chip">‡∏≠‡∏≤‡∏¢‡∏∏ ${p.age ?? '-'}</span>
  <span class="chip">${(p.birth || '').split('-').reverse().join('/')}</span>
</div>
    </div>
  </div>
`).join('');

      grid.innerHTML = items || `<div class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>`;
    }

    $('#btnAddNewPlayer')?.addEventListener('click', ()=>{
      const teamId=$('#npTeam').value; const team=state.teams.find(t=>t.id===teamId);
      if(!team) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°');
      const name=$('#npName').value.trim(), pos=$('#npPos').value, num=$('#npNum').value;
      const birth=$('#npBirth').value; const age=parseInt($('#npAge').value||calcAgeFromISO(birth)||0,10);
      if(!name||!pos||!age) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î/‡∏≠‡∏≤‡∏¢‡∏∏');

      team.members.push({ id:nid('p'), name, pos, num, birth, age, photo: tempPlayerPhoto||'' });
      save(); renderRosterGrid(); renderDashboard();
      ['npName','npPos','npNum','npBirth','npAge'].forEach(k=>$('#'+k).value='');
      tempPlayerPhoto=''; $('#preview').innerHTML='üë§'; $('#npPhoto').value='';
      log(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤ ${name} ‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏° ${team.name}`);
    });

    $('#btnClearNewPlayer')?.addEventListener('click', ()=>{
      ['npName','npPos','npNum','npBirth','npAge'].forEach(k=>$('#'+k).value='');
      tempPlayerPhoto=''; $('#preview').innerHTML='üë§'; $('#npPhoto').value='';
    });
    $('#btnCancelNewPlayer')?.addEventListener('click', ()=> $('#addPlayerForm').classList.add('hidden'));

    $('#btnDownloadRoster')?.addEventListener('click', ()=>{
      const teamId=$('#selRosterTeam').value; const team=state.teams.find(t=>t.id===teamId);
      if(!team) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
      const blob=new Blob([JSON.stringify({team:team.name,players:team.members},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`roster-${team.name}.json`; a.click(); URL.revokeObjectURL(url);
    });

    $('#btnToggleAddPlayer')?.addEventListener('click', ()=> $('#addPlayerForm').classList.toggle('hidden'));
    $('#selRosterTeam')?.addEventListener('change', renderRosterGrid);

    // theme color (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡∏°/‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå)
    const colorInput = $('#teamColor');
    function setThemeColor(hex){
      document.documentElement.style.setProperty('--team-color', hex);
      // contrast
      const {r,g,b} = (function hexToRgb(h){ h=h.replace('#',''); if(h.length===3)h=[...h].map(x=>x+x).join(''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; })(hex);
      const yiq=(r*299+g*587+b*114)/1000;
      document.documentElement.style.setProperty('--team-contrast', yiq>=140?'#0b1220':'#ffffff');
      localStorage.setItem('ce_v2_theme_color', hex);
    }
    if(colorInput){
      const saved = localStorage.getItem('ce_v2_theme_color'); if(saved) { colorInput.value=saved; setThemeColor(saved); }
      colorInput.addEventListener('input', e=> setThemeColor(e.target.value));
    }

    // ====== Import / Export / Save / Clear ======
    $('#btnSave')?.addEventListener('click', ()=>{ save(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });
    $('#btnExport')?.addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='football-ce-v2-state.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#importFile')?.addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=ev=>{ try{
        const obj=JSON.parse(ev.target.result);
        if(!obj||!Array.isArray(obj.teams)) throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        state = { teams: obj.teams||[], matches: obj.matches||[], playersStats: obj.playersStats||[] };
        save(); afterStateChangeAll(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(err){ alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message); } };
      r.readAsText(f);
    });
    $('#btnClear')?.addEventListener('click', ()=>{
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state={teams:[],matches:[],playersStats:[]};
      seedIfEmpty(); afterStateChangeAll(); alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
    });

    // ====== Seed if empty ======
    function seedIfEmpty(){
      if(state.teams?.length) return;
      const t1={id:nid('team'),name:'Manchester City',logo:'',members:[]};
      const t2={id:nid('team'),name:'Arsenal',logo:'',members:[]};
      state.teams=[t1,t2];
      save();
    }

    // ====== Page-wide refresh after state changed ======
    function afterStateChangeAll(){
      renderTeamSelects();
      // set default selects
      if($('#selHome') && state.teams[0]) $('#selHome').value = state.teams[0].id;
      if($('#selAway') && state.teams[1]) $('#selAway').value = state.teams[1].id;
      if($('#selTeamForPlayer') && state.teams[0]) $('#selTeamForPlayer').value = state.teams[0].id;
      if($('#selRosterTeam') && state.teams[0]) $('#selRosterTeam').value = state.teams[0].id;
      if($('#npTeam') && state.teams[0]) $('#npTeam').value = state.teams[0].id;

      renderPlayerDropdowns();
      renderTable();
      renderDashboard();
      renderMatchLog();
      renderTopStats();
      renderRosterGrid();
      // fill edit team preview
      renderTeamEditPreview(null);
    }

function logSync(m){ try{ log('[SYNC] ' + m); } catch { console.log('[SYNC]', m); } }

function listenCloud(){
  if (!roomId) return;
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  unsubscribe = db.collection('rooms').doc(roomId).onSnapshot(doc=>{
    const d = doc.data();
    if (!d || !d.state) return;
    if (d.senderId === deviceId) return;
    state = d.state; _save(); afterStateChangeAll();
    logSync(`pull ok ‚Ä¢ updatedAt=${new Date(d.updatedAt).toLocaleTimeString()}`);
  }, err=> logSync('pull error: ' + err.message));
}

async function pushCloud(){
  if (!roomId) return;
  try{
    await db.collection('rooms').doc(roomId).set({
      state, senderId: deviceId, updatedAt: Date.now()
    }, { merge:true });
    logSync('push ok ' + new Date().toLocaleTimeString());
  }catch(e){ logSync('push error: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', () => {
  startSyncCloudFirst();
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≠‡∏¢ seed
async function startSyncCloudFirst(){
  if (!roomId) return;
  const ref = db.collection('rooms').doc(roomId);
  try {
    const snap = await ref.get();
    const data = snap.data();

    if (snap.exists && data?.state) {
      // ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
      state = data.state;
      _save();                 // ‡πÄ‡∏ã‡∏ü‡πÇ‡∏•‡∏Ñ‡∏±‡∏• (‡πÑ‡∏°‡πà push)
      afterStateChangeAll();
      logSync('startup: loaded from cloud');
    } else {
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏ß‡πà‡∏≤‡∏á ‡∏Ñ‡πà‡∏≠‡∏¢ seed ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      await ref.set({ state, senderId: deviceId, updatedAt: Date.now() }, { merge:true });
      logSync('startup: seeded because cloud empty');
    }

    // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á realtime
    listenCloud();
  } catch (e) {
    logSync('startup error: ' + e.message);
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    listenCloud();
  }
}

         
       // ====== INIT ======
    function init(){
      load();
      seedIfEmpty();
      renderTeamSelects();

      // defaults
      if($('#selHome') && state.teams[0]) $('#selHome').value = state.teams[0].id;
      if($('#selAway') && state.teams[1]) $('#selAway').value = state.teams[1].id;
      if($('#selTeamForPlayer') && state.teams[0]) $('#selTeamForPlayer').value = state.teams[0].id;
      if($('#selRosterTeam') && state.teams[0]) $('#selRosterTeam').value = state.teams[0].id;
      if($('#npTeam') && state.teams[0]) $('#npTeam').value = state.teams[0].id;

      renderPlayerDropdowns();
      renderTable();
      renderDashboard();
      renderMatchLog();
      renderTopStats();
      renderRosterGrid();
      log('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
    }
    document.addEventListener('DOMContentLoaded', init);

    /* ===========================
   REAL-TIME SYNC (Firestore)
   =========================== */
(function(){
  // 1) ‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å Firebase Console (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
  const firebaseConfig = {
    apiKey: "AIzaSyDOtVCtlgMe1X1F2ewis2Hi0E59jl0eDQk",
    authDomain: "footballprogram-93b7d.firebaseapp.com",
    projectId: "footballprogram-93b7d",
  };

  // 2) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ SDK ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠ initializeApp)
  if (!window.firebase || !firebase.initializeApp) {
    console.error('Firebase SDK not loaded');
    return;
  }

  // 3) Init + Firestore + Anonymous Auth
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  firebase.auth().signInAnonymously().catch(e=>{
    console.error(e); alert('Firebase auth error: ' + e.message);
  });

    // 4) ‡πÉ‡∏ä‡πâ room 'jakhong' ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á ?room= ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏° prompt)
  const ROOM_KEY = 'ce_v2_room', DEVICE_KEY = 'ce_v2_device';
  const DEFAULT_ROOM = 'jakhong';
  const FORCE_ROOM = true; // true = ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ DEFAULT_ROOM ‡πÄ‡∏™‡∏°‡∏≠

  let roomId = FORCE_ROOM
    ? DEFAULT_ROOM
    : (new URLSearchParams(location.search).get('room')?.trim()
       || localStorage.getItem(ROOM_KEY)
       || DEFAULT_ROOM);

  if (roomId) localStorage.setItem(ROOM_KEY, roomId);

  let deviceId = localStorage.getItem(DEVICE_KEY);
  if (!deviceId) {
    deviceId = 'dev_' + Math.random().toString(36).slice(2);
    localStorage.setItem(DEVICE_KEY, deviceId);
  }

  // 5) ‡∏ü‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
  let unsubscribe = null;
  function listenCloud(){
    if (!roomId) return;
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    unsubscribe = db.collection('rooms').doc(roomId).onSnapshot(doc=>{
      const d = doc.data();
      if (!d || !d.state) return;
      if (d.senderId === deviceId) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á
      state = d.state;
_save();              // <-- ‡πÉ‡∏ä‡πâ _save() ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏•‡∏Ñ‡∏±‡∏• ‡πÑ‡∏°‡πà push)
afterStateChangeAll();
      try { log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå (${roomId})`); } catch {}
    });
  }

  // 6) ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà save() (debounce)
  async function pushCloud(){
    if (!roomId) return;
    try {
      await db.collection('rooms').doc(roomId).set({
        state,
        senderId: deviceId,
        updatedAt: Date.now()
      }, { merge: true });
    } catch (e) { console.error('push fail', e); }
  }
  const _save = save;
  let _t;
  save = function(){
    _save();
    clearTimeout(_t);
    _t = setTimeout(pushCloud, 600);
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    listenCloud();
    // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ä‡πà‡∏ß‡∏¢ seed ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
    setTimeout(pushCloud, 0);
  });
})();
  </script>
</body>
</html>


