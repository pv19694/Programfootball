<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‚Äî CE v2 (Fixed)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme:light}
    body{font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .page{display:none} .page.active{display:block}
    .btn{background:#f8fafc;border-radius:0.75rem;padding:.6rem .8rem;font-weight:600}
    .btn.active,.btn:hover{background:#e0f2fe}
    .card{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem;text-align:center}
    .card .t{font-size:.85rem;color:#64748b}
    .card .v{font-size:1.5rem;font-weight:800;color:#2563eb}
    .lbl{display:block;font-size:.8rem;font-weight:700;color:#334155;margin-bottom:.25rem}
    .sel,.inp{width:100%;padding:.65rem;border:2px solid #e5e7eb;border-radius:.9rem}
    .btn-main{background:#10b981;color:#fff;font-weight:700;border-radius:.9rem;padding:.6rem 1rem}
    .btn-s{background:#3b82f6;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .btn-danger{background:#ef4444;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .panel{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem}
    table th,table td{padding:.5rem;text-align:center}
    .form-row{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:.75rem}
    @media(min-width:768px){.form-row{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white/90 backdrop-blur shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <div class="text-3xl">‚öΩ</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏• ‚Äî CE v2</h1>
          <p class="text-sm text-gray-600">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà
            <button id="wk-" class="px-2 rounded bg-gray-100 hover:bg-gray-200" title="‡∏•‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">‚àí</button>
            <span id="wk" class="font-semibold">1</span>
            <button id="wk+" class="px-2 rounded bg-gray-100 hover:bg-gray-200" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">Ôºã</button>
            | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <span id="now">--:--:--</span>
          </p>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnSave"   class="text-sm bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="btnExport" class="text-sm bg-sky-500 hover:bg-sky-600 text-white px-3 py-1.5 rounded-lg">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
        <label class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-lg cursor-pointer">
          üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤<input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnClear" class="text-sm bg-rose-500 hover:bg-rose-600 text-white px-3 py-1.5 rounded-lg">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="bg-white shadow">
    <div class="container mx-auto px-4 py-2 grid grid-cols-3 md:grid-cols-6 gap-2">
      <button class="tab btn active" data-p="dashboard">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <button class="tab btn" data-p="table">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
      <button class="tab btn" data-p="match">‚öΩ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
      <button class="tab btn" data-p="players">üë§ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
      <button class="tab btn" data-p="teams">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</button>
      <button class="tab btn" data-p="roster">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Dashboard -->
    <section id="dashboard" class="page active">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card"><div class="t">‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statTeams" class="v">0</div></div>
        <div class="card"><div class="t">‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statMatches" class="v">0</div></div>
        <div class="card"><div class="t">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statMembers" class="v">0</div></div>
        <div class="card"><div class="t">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div id="statWeek" class="v">1</div></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">ü•á Top Teams</h3>
        <div id="topTeams" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">üóìÔ∏è ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="recentMatches" class="space-y-2"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">üìä ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="activities" class="space-y-2 max-h-64 overflow-y-auto" aria-live="polite"></div>
      </div>
    </section>

    <!-- Table -->
    <section id="table" class="page">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 text-center text-xl font-bold">JAKHONG LEAGUE 3</div>
        <div class="p-3 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-700 text-white">
              <tr><th>#</th><th class="text-left">‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>+/-</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏ü‡∏≠‡∏£‡πå‡∏°</th></tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Match -->
    <section id="match" class="page">
      <div class="bg-white rounded-2xl shadow p-5 max-w-3xl mx-auto space-y-4">
        <div class="form-row">
          <div><label class="lbl">‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤</label><select id="selHome" class="sel"></select></div>
          <div><label class="lbl">‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô</label><select id="selAway" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="lbl">‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏¢‡πâ‡∏≤</label><input id="hg" type="number" min="0" max="20" value="0" class="inp text-center"></div>
          <div><label class="lbl">‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô</label><input id="ag" type="number" min="0" max="20" value="0" class="inp text-center"></div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
          <button id="saveMatch" class="btn-main">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
          <button id="incH" class="btn-s" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏¢‡πâ‡∏≤">üè† +1 ‡πÄ‡∏´‡∏¢‡πâ‡∏≤</button>
          <button id="incA" class="btn-s" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô">üõ´ +1 ‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô</button>
          <button id="setDraw" class="btn-s" title="‡∏ï‡∏±‡πâ‡∏á 1‚Äì1">‚öñÔ∏è 1‚Äì1</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏°‡∏ï‡∏ä‡πå</h3>
        <div id="matchLog" class="space-y-2 max-h-80 overflow-y-auto"></div>
      </div>
    </section>

    <!-- Players (minimal wiring) -->
    <section id="players" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <h3 class="text-center font-bold text-gray-800 mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
        <div class="form-row mb-3">
          <div><label class="lbl">‡∏ó‡∏µ‡∏°</label><select id="selTeamForPlayer" class="sel"></select></div>
          <div><label class="lbl">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label><select id="selPlayer" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <button data-s="goals" class="btn-stat btn-s">‚öΩ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π</button>
          <button data-s="assists" class="btn-stat btn-s">üéØ ‡πÅ‡∏≠‡∏™‡∏ã‡∏¥‡∏™‡∏ï‡πå</button>
          <button data-s="saves" class="btn-stat btn-s">ü•Ö ‡πÄ‡∏ã‡∏ü</button>
          <button data-s="cleanSheets" class="btn-stat btn-s">üõ°Ô∏è ‡∏Ñ‡∏•‡∏µ‡∏ô‡∏ä‡∏µ‡∏ó</button>
          <button data-s="yellowCards" class="btn-stat btn-s">üü® ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</button>
          <button data-s="redCards" class="btn-stat btn-s">üü• ‡πÅ‡∏î‡∏á</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
        <div class="panel"><h4>üèÜ ‡∏î‡∏≤‡∏ß‡∏ã‡∏±‡∏•‡πÇ‡∏ß</h4><div id="topGoals"></div></div>
        <div class="panel"><h4>üéØ ‡πÅ‡∏≠‡∏™‡∏ã‡∏¥‡∏™‡∏ï‡πå</h4><div id="topAssists"></div></div>
        <div class="panel"><h4>ü•Ö ‡∏Ñ‡∏•‡∏µ‡∏ô‡∏ä‡∏µ‡∏ó</h4><div id="topCS"></div></div>
      </div>
    </section>

    <!-- Teams (with logo upload) -->
    <section id="teams" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div><label class="lbl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</label><select id="selEditTeam" class="sel"></select></div>
          <div><label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</label><input id="inpTeamName" class="inp" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°"></div>
          <div>
            <label class="lbl">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡∏°</label>
            <div class="flex items-center gap-3">
              <div id="teamLogoPreviewEdit" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">üè≥Ô∏è</div>
              <input id="teamLogoInputEdit" type="file" accept="image/*" class="hidden">
              <button id="btnChooseTeamLogoEdit" class="btn-s">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
              <button id="btnClearTeamLogoEdit" class="btn-danger">üßπ ‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnTeamUpdate" class="btn-main">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button id="btnTeamAdd" class="btn-s">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnTeamDelete" class="btn-danger">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡∏°</button>
        </div>
        <div class="mt-4 p-4 rounded-xl bg-white/70 border">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="lbl">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</label>
              <div class="flex items-center gap-3">
                <div id="teamLogoPreviewNew" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">üè≥Ô∏è</div>
                <input id="teamLogoInputNew" type="file" accept="image/*" class="hidden">
                <button id="btnChooseTeamLogoNew" class="btn-s">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà</label>
              <input id="inpTeamNameNew" class="inp" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Roster -->
    <section id="roster" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex items-center gap-2"><span class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°:</span><select id="selRosterTeam" class="sel w-56"></select></div>
        <button id="btnToggleAddPlayer" class="btn-main">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
      </div>
      <div id="addPlayerForm" class="bg-white rounded-2xl shadow p-5 mb-5 hidden">
        <h3 class="text-center font-bold text-gray-800 mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="form-row">
          <div><label class="lbl">‡∏ó‡∏µ‡∏° *</label><select id="npTeam" class="sel"></select></div>
          <div><label class="lbl">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input id="npName" class="inp"></div>
          <div><label class="lbl">‡∏≠‡∏≤‡∏¢‡∏∏ *</label><input id="npAge" type="number" min="15" max="50" class="inp"></div>
          <div><label class="lbl">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input id="npBirth" type="date" class="inp"></div>
          <div><label class="lbl">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *</label>
            <select id="npPos" class="sel">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
              <option value="goalkeeper">ü•Ö ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
              <option value="defender">üõ°Ô∏è ‡∏Å‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</option>
              <option value="midfielder">‚öΩ ‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</option>
              <option value="forward">üéØ ‡∏Å‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
            </select>
          </div>
          <div><label class="lbl">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠</label><input id="npNum" type="number" min="1" max="99" class="inp"></div>
          <div><label class="lbl">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input id="npPhone" class="inp" placeholder="081-234-5678"></div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnAddNewPlayer" class="btn-main">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</button>
          <button id="btnClearNewPlayer" class="btn-s">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          <button id="btnCancelNewPlayer" class="btn-danger">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
      <div id="rosterWrap"></div>
    </section>
  </main>

  <script>
// ===================== Helpers & Storage =====================
const STORAGE_KEY = 'football_state_ce_v2_fixed';
const $   = (s, r=document)=>r.querySelector(s);
const $$  = (s, r=document)=>[...r.querySelectorAll(s)];
const esc = (s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
                            .replaceAll('>','&gt;').replaceAll('"','&quot;')
                            .replaceAll("'","&#039;");
const newid  = p=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
const nowStr = ()=>new Date().toLocaleString('th-TH');

let state = {
  week: 1,
  teams: [],            // {id,name,logo,members:[{id,name,pos,age,stats:{...}}]}
  matches: [],          // {id, at, homeId, awayId, hg, ag}
  activities: []        // string log lines
};

function logActivity(t){
  state.activities.unshift(`[${nowStr()}] ${t}`);
  state.activities = state.activities.slice(0,100);
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
  } catch {}
  if(!Array.isArray(state.teams)) state.teams = [];
  if(!Array.isArray(state.matches)) state.matches = [];
  if(!Array.isArray(state.activities)) state.activities = [];
  if(!state.week) state.week = 1;
}

function seedIfEmpty(){
  if(state.teams.length) return;
  const t1 = {id:newid('team'), name:'Manchester City', logo:'', members:[]};
  const t2 = {id:newid('team'), name:'Arsenal', logo:'', members:[]};
  state.teams = [t1,t2];
  logActivity('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (2 ‡∏ó‡∏µ‡∏°)');
  save();
}

// ===================== Navigation (FIXED TABS) =====================
function bindTabs(){
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const page = btn.dataset.p;
      $$('.page').forEach(p=>p.classList.remove('active'));
      const el = document.getElementById(page);
      if(el){ el.classList.add('active'); }
      // render on enter
      if(page==='table') renderTable();
      if(page==='match') refreshMatchSelectors();
      if(page==='players') refreshPlayerSelectors();
      if(page==='roster') renderRoster();
      if(page==='dashboard') renderDashboard();
      if(page==='teams') renderTeamSelects();
    });
  });
}

// ===================== Team UI =====================
function renderTeamSelects(){
  const opts = ['<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° --</option>'].concat(
    state.teams.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`) ).join('');
  ['selEditTeam','selHome','selAway','selRosterTeam','npTeam','selTeamForPlayer']
    .forEach(id=>{ const el=$(`#${id}`); if(el) el.innerHTML = id==='selHome'||id==='selAway'? opts.replace('value=""">','value="" hidden>') : opts; });
}

function showLogoPreview(targetId, teamOrUrl){
  const box = document.getElementById(targetId);
  if(!box) return;
  let url = '';
  if(typeof teamOrUrl === 'string') url = teamOrUrl;
  else if(teamOrUrl && teamOrUrl.logo) url = teamOrUrl.logo;
  box.innerHTML = url ? `<img src="${url}" class="w-full h-full object-cover" alt="logo">` : 'üè≥Ô∏è';
}

let pendingEditLogo = ''; // for edit
let pendingNewLogo  = ''; // for new

function bindLogoPickers(){
  const inputEdit = $('#teamLogoInputEdit');
  const inputNew  = $('#teamLogoInputNew');
  $('#btnChooseTeamLogoEdit')?.addEventListener('click',()=>inputEdit?.click());
  $('#btnChooseTeamLogoNew') ?.addEventListener('click',()=>inputNew?.click());
  $('#btnClearTeamLogoEdit') ?.addEventListener('click',()=>{ pendingEditLogo=''; showLogoPreview('teamLogoPreviewEdit',''); });

  function onPick(fileInput, setter){
    const f = fileInput.files?.[0];
    if(!f) return;
    if(!f.type.startsWith('image/')){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); fileInput.value=''; return; }
    if(f.size>5*1024*1024){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); fileInput.value=''; return; }
    const r = new FileReader();
    r.onload = ev=>{ setter(ev.target.result); };
    r.readAsDataURL(f);
  }
  inputEdit?.addEventListener('change', e=> onPick(e.target, url=>{ pendingEditLogo=url; showLogoPreview('teamLogoPreviewEdit',url);}));
  inputNew ?.addEventListener('change', e=> onPick(e.target, url=>{ pendingNewLogo =url; showLogoPreview('teamLogoPreviewNew', url);}));
}

function addTeam(){
  const name = $('#inpTeamNameNew').value.trim();
  if(!name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà');
  if(state.teams.some(t=>t.name===name)) return alert('‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
  state.teams.push({ id:newid('team'), name, logo: pendingNewLogo||'', members: [] });
  logActivity(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà: ${name}`);
  pendingNewLogo=''; $('#inpTeamNameNew').value=''; showLogoPreview('teamLogoPreviewNew','');
  renderTeamSelects(); renderDashboard(); save();
  alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

function updateTeam(){
  const id = $('#selEditTeam').value; const name = $('#inpTeamName').value.trim();
  if(!id) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°');
  if(!name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°');
  const t = state.teams.find(x=>x.id===id); if(!t) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°');
  t.name = name; if(pendingEditLogo) t.logo = pendingEditLogo;
  logActivity(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏°: ${name}`);
  pendingEditLogo=''; showLogoPreview('teamLogoPreviewEdit', t);
  renderTeamSelects(); renderTable(); renderDashboard(); save();
  alert('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

function deleteTeam(){
  const id = $('#selEditTeam').value; if(!id) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°');
  const t = state.teams.find(x=>x.id===id); if(!t) return;
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏µ‡∏° "${t.name}" ?`)) return;
  state.matches = state.matches.filter(m=>m.homeId!==id && m.awayId!==id);
  state.teams   = state.teams.filter(x=>x.id!==id);
  logActivity(`‡∏•‡∏ö‡∏ó‡∏µ‡∏°: ${t.name}`);
  $('#inpTeamName').value=''; pendingEditLogo=''; showLogoPreview('teamLogoPreviewEdit','');
  renderTeamSelects(); renderTable(); renderDashboard(); save();
  alert('üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

function bindTeamSection(){
  $('#btnTeamAdd')   ?.addEventListener('click', addTeam);
  $('#btnTeamUpdate')?.addEventListener('click', updateTeam);
  $('#btnTeamDelete')?.addEventListener('click', deleteTeam);
  $('#selEditTeam')  ?.addEventListener('change', e=>{
    const t = state.teams.find(x=>x.id===e.target.value);
    $('#inpTeamName').value = t?.name || '';
    pendingEditLogo=''; showLogoPreview('teamLogoPreviewEdit', t||'');
  });
}

// ===================== Matches & Table =====================
function refreshMatchSelectors(){
  ['selHome','selAway'].forEach(id=>{ const el=$('#'+id); if(el && el.value==='') el.selectedIndex=1; });
}

function addMatch(){
  const homeId = $('#selHome').value; const awayId = $('#selAway').value;
  const hg = +$('#hg').value|0; const ag = +$('#ag').value|0;
  if(!homeId || !awayId || homeId===awayId) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  state.matches.unshift({ id:newid('m'), at: Date.now(), homeId, awayId, hg, ag });
  logActivity(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•: ${teamName(homeId)} ${hg}‚Äì${ag} ${teamName(awayId)}`);
  $('#hg').value=0; $('#ag').value=0;
  renderMatchLog(); renderTable(); renderDashboard(); save();
}

function teamName(id){ return state.teams.find(t=>t.id===id)?.name || 'Unknown'; }

function renderMatchLog(){
  const wrap = $('#matchLog'); if(!wrap) return;
  wrap.innerHTML = state.matches.slice(0,50).map(m=>{
    const d = new Date(m.at).toLocaleString('th-TH');
    return `<div class="p-2 rounded bg-gray-50 border"><strong>${esc(teamName(m.homeId))}</strong> ${m.hg}‚Äì${m.ag} <strong>${esc(teamName(m.awayId))}</strong> <span class="text-xs text-gray-500">${d}</span></div>`;
  }).join('');
}

function calcTable(){
  const map = new Map();
  state.teams.forEach(t=>map.set(t.id,{ id:t.id, name:t.name, logo:t.logo, P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0, form:[] }));
  state.matches.forEach(m=>{
    const H = map.get(m.homeId); const A = map.get(m.awayId);
    if(!H||!A) return; H.P++; A.P++; H.GF+=m.hg; H.GA+=m.ag; A.GF+=m.ag; A.GA+=m.hg;
    if(m.hg>m.ag){ H.W++; A.L++; H.PTS+=3; H.form.push('W'); A.form.push('L'); }
    else if(m.hg<m.ag){ A.W++; H.L++; A.PTS+=3; A.form.push('W'); H.form.push('L'); }
    else { H.D++; A.D++; H.PTS++; A.PTS++; H.form.push('D'); A.form.push('D'); }
    H.GD = H.GF - H.GA; A.GD = A.GF - A.GA;
    H.form = H.form.slice(-5); A.form = A.form.slice(-5);
  });
  return [...map.values()].sort((a,b)=> b.PTS-a.PTS || b.GD-a.GD || b.GF-a.GF || a.name.localeCompare(b.name));
}

function renderTable(){
  const tbody = $('#tbl'); if(!tbody) return;
  const rows = calcTable();
  tbody.innerHTML = rows.map((r,i)=>{
    const form = r.form.map(x=> x==='W'?'üü©':x==='D'?'üü®':'üü•').join('');
    return `<tr class="odd:bg-white even:bg-slate-50">
      <td class="font-bold">${i+1}</td>
      <td class="text-left flex items-center gap-2">${r.logo?`<img src="${r.logo}" class="w-6 h-6 rounded-full">`:''}${esc(r.name)}</td>
      <td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td>
      <td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td><td class="font-bold">${r.PTS}</td><td>${form}</td>
    </tr>`;
  }).join('');
}

// ===================== Players (minimal example) =====================
function refreshPlayerSelectors(){
  const teamId = $('#selTeamForPlayer').value || state.teams[0]?.id || '';
  $('#selTeamForPlayer').value = teamId;
  const team = state.teams.find(t=>t.id===teamId);
  const players = team?.members || [];
  $('#selPlayer').innerHTML = players.length? players.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('') : '<option value="">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)</option>';
}

function addPlayerToTeam(){
  const teamId = $('#npTeam').value; const name = $('#npName').value.trim();
  const age = +($('#npAge').value||0); const pos = $('#npPos').value;
  if(!teamId||!name||!age||!pos) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const team = state.teams.find(t=>t.id===teamId); if(!team) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°');
  team.members.push({ id:newid('p'), name, age, pos, stats:{ goals:0, assists:0, saves:0, cleanSheets:0, yellowCards:0, redCards:0 } });
  logActivity(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡∏° ${team.name}`);
  renderRoster(); refreshPlayerSelectors(); renderDashboard(); save();
  ['npName','npAge','npBirth','npNum','npPhone'].forEach(id=>$('#'+id).value=''); $('#npPos').value='';
}

function renderRoster(){
  const teamId = $('#selRosterTeam').value || state.teams[0]?.id || '';
  $('#selRosterTeam').value = teamId;
  const team = state.teams.find(t=>t.id===teamId);
  const wrap = $('#rosterWrap');
  if(!team){ wrap.innerHTML='<div class="p-4 bg-white rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°</div>'; return; }
  wrap.innerHTML = `<div class="bg-white rounded-2xl shadow p-5">
    <h3 class="font-bold text-gray-800 mb-3">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠: ${esc(team.name)}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">${
      (team.members||[]).map(m=>`<div class="p-3 rounded-xl border bg-white flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-slate-200 grid place-items-center">üë§</div>
        <div><div class="font-bold">${esc(m.name)}</div><div class="text-xs text-gray-500">${esc(m.pos||'')}, ‡∏≠‡∏≤‡∏¢‡∏∏ ${m.age||'-'}</div></div>
      </div>`).join('') || '<div class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</div>'
    }</div></div>`;
}

// ===================== Dashboard =====================
function renderDashboard(){
  $('#statTeams').textContent   = String(state.teams.length);
  $('#statMatches').textContent = String(state.matches.length);
  $('#statMembers').textContent = String(state.teams.reduce((n,t)=>n+(t.members?.length||0),0));
  $('#statWeek').textContent    = String(state.week);
  $('#wk').textContent          = String(state.week);
  $('#now').textContent         = new Date().toLocaleTimeString('th-TH');

  // Top teams
  const top = calcTable().slice(0,6);
  $('#topTeams').innerHTML = top.map((t,i)=>`<div class="p-3 rounded-xl border bg-white flex items-center gap-3">
    <div class="text-xl w-8">${i+1}.</div>
    ${t.logo?`<img src="${t.logo}" class="w-10 h-10 rounded-full">`: '<div class="w-10 h-10 rounded-full bg-slate-200 grid place-items-center">üè≥Ô∏è</div>'}
    <div class="flex-1">
      <div class="font-bold">${esc(t.name)}</div>
      <div class="text-xs text-gray-500">${t.PTS} pts ‚Ä¢ GD ${t.GD}</div>
    </div>
  </div>`).join('') || '<div class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';

  // recent matches
  $('#recentMatches').innerHTML = state.matches.slice(0,5).map(m=>`<div class="p-2 rounded bg-gray-50 border">
    ${esc(teamName(m.homeId))} <strong>${m.hg}‚Äì${m.ag}</strong> ${esc(teamName(m.awayId))}
  </div>`).join('') || '<div class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå</div>';

  // activities
  $('#activities').innerHTML = state.activities.map(a=>`<div class="text-sm">${esc(a)}</div>`).join('');
}

// ===================== Import/Export/Clear =====================
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='football_state.json'; a.click();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const r = new FileReader();
  r.onload = ev=>{
    try{ const data = JSON.parse(ev.target.result);
      if(!data || typeof data!=='object') throw 0;
      state = Object.assign({week:1,teams:[],matches:[],activities:[]}, data);
      logActivity('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå');
      afterStateChange();
    }catch{ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
  };
  r.readAsText(file);
}
function clearAll(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ localStorage.removeItem(STORAGE_KEY); state={week:1,teams:[],matches:[],activities:[]}; seedIfEmpty(); afterStateChange(); } }

function afterStateChange(){ save(); renderTeamSelects(); renderTable(); renderMatchLog(); renderRoster(); renderDashboard(); }

// ===================== Bind Global Controls =====================
function bindGlobal(){
  $('#saveMatch')?.addEventListener('click', addMatch);
  $('#incH')?.addEventListener('click', ()=> $('#hg').value = (+$('#hg').value|0)+1);
  $('#incA')?.addEventListener('click', ()=> $('#ag').value = (+$('#ag').value|0)+1);
  $('#setDraw')?.addEventListener('click', ()=> { $('#hg').value=1; $('#ag').value=1; });

  $('#btnSave')  ?.addEventListener('click', ()=>{ save(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); });
  $('#btnExport')?.addEventListener('click', exportJSON);
  $('#importFile')?.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });
  $('#btnClear') ?.addEventListener('click', clearAll);

  $('#btnToggleAddPlayer')?.addEventListener('click', ()=> $('#addPlayerForm').classList.toggle('hidden'));
  $('#btnAddNewPlayer')   ?.addEventListener('click', addPlayerToTeam);
  $('#btnClearNewPlayer') ?.addEventListener('click', ()=>{ ['npName','npAge','npBirth','npNum','npPhone'].forEach(id=>$('#'+id).value=''); $('#npPos').value=''; });
  $('#btnCancelNewPlayer')?.addEventListener('click', ()=> $('#addPlayerForm').classList.add('hidden'));

  // roster/team selects changes
  $('#selRosterTeam')?.addEventListener('change', renderRoster);
  $('#selTeamForPlayer')?.addEventListener('change', refreshPlayerSelectors);

  // week controls
  $('#wk+')?.addEventListener('click', ()=>{ state.week++; afterStateChange(); });
  $('#wk-')?.addEventListener('click', ()=>{ state.week=Math.max(1, state.week-1); afterStateChange(); });

  // clock tick
  setInterval(()=> $('#now').textContent = new Date().toLocaleTimeString('th-TH'), 1000);
}

// ===================== Init =====================
function init(){
  bindTabs();
  bindLogoPickers();
  bindTeamSection();
  bindGlobal();
  load();
  seedIfEmpty();
  renderTeamSelects();
  renderTable();
  renderMatchLog();
  renderRoster();
  renderDashboard();
}

document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
