
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบตารางคะแนนฟุตบอล — CE v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme:light} body{font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .page{display:none} .page.active{display:block}
    .btn{background:#f8fafc;border-radius:0.75rem;padding:.6rem .8rem;font-weight:600}
    .btn.active,.btn:hover{background:#e0f2fe}
    .card{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem;text-align:center}
    .card .t{font-size:.85rem;color:#64748b}
    .card .v{font-size:1.5rem;font-weight:800;color:#2563eb}
    .lbl{display:block;font-size:.8rem;font-weight:700;color:#334155;margin-bottom:.25rem}
    .sel,.inp{width:100%;padding:.65rem;border:2px solid #e5e7eb;border-radius:.9rem}
    .btn-main{background:#10b981;color:#fff;font-weight:700;border-radius:.9rem;padding:.6rem 1rem}
    .btn-s{background:#3b82f6;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .btn-danger{background:#ef4444;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .panel{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem}
    table th,table td{padding:.5rem;text-align:center}
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white/90 backdrop-blur shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <div class="text-3xl">⚽</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-gray-800">ระบบตารางคะแนนฟุตบอล — CE v2</h1>
          <p class="text-sm text-gray-600">สัปดาห์ที่
            <button id="wk-" class="px-2 rounded bg-gray-100 hover:bg-gray-200">−</button>
            <span id="wk" class="font-semibold">1</span>
            <button id="wk+" class="px-2 rounded bg-gray-100 hover:bg-gray-200">＋</button>
            | อัปเดต: <span id="now">--:--:--</span>
          </p>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnSave" class="text-sm bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg">💾 บันทึก</button>
        <button id="btnExport" class="text-sm bg-sky-500 hover:bg-sky-600 text-white px-3 py-1.5 rounded-lg">📤 ส่งออก</button>
        <label class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-lg cursor-pointer">
          📥 นำเข้า<input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnClear" class="text-sm bg-rose-500 hover:bg-rose-600 text-white px-3 py-1.5 rounded-lg">🧹 ล้างข้อมูล</button>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="bg-white shadow">
    <div class="container mx-auto px-4 py-2 grid grid-cols-3 md:grid-cols-6 gap-2">
      <button class="tab btn active" data-p="dashboard">🏠 หน้าหลัก</button>
      <button class="tab btn" data-p="table">🏆 ตารางคะแนน</button>
      <button class="tab btn" data-p="match">⚽ บันทึกผล</button>
      <button class="tab btn" data-p="players">👤 สถิติผู้เล่น</button>
      <button class="tab btn" data-p="teams">⚙️ จัดการทีม</button>
      <button class="tab btn" data-p="roster">📋 รายชื่อนักกีฬา</button>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Dashboard -->
    <section id="dashboard" class="page active">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card"><div class="t">ทีมทั้งหมด</div><div id="statTeams" class="v"></div></div>
        <div class="card"><div class="t">แมตช์ทั้งหมด</div><div id="statMatches" class="v"></div></div>
        <div class="card"><div class="t">สมาชิกทั้งหมด</div><div id="statMembers" class="v"></div></div>
        <div class="card"><div class="t">สัปดาห์ปัจจุบัน</div><div id="statWeek" class="v"></div></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">🥇 Top Teams</h3>
        <div id="topTeams" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">🗓️ แมตช์ล่าสุด</h3>
        <div id="recentMatches" class="space-y-2"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">📊 กิจกรรมล่าสุด</h3>
        <div id="activities" class="space-y-2 max-h-64 overflow-y-auto" aria-live="polite"></div>
      </div>
    </section>

    <!-- Table -->
    <section id="table" class="page">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 text-center text-xl font-bold">JAKHONG LEAGUE 3</div>
        <div class="p-3 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-700 text-white">
              <tr><th>#</th><th class="text-left">ทีม</th><th>แข่ง</th><th>ชนะ</th><th>เสมอ</th><th>แพ้</th><th>ได้</th><th>เสีย</th><th>+/-</th><th>คะแนน</th><th>ฟอร์ม</th></tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Match -->
    <section id="match" class="page">
      <div class="bg-white rounded-2xl shadow p-5 max-w-3xl mx-auto space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="lbl">ทีมเหย้า</label><select id="selHome" class="sel"></select></div>
          <div><label class="lbl">ทีมเยือน</label><select id="selAway" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="lbl">สกอร์เหย้า</label><input id="hg" type="number" min="0" max="20" value="0" class="inp text-center"></div>
          <div><label class="lbl">สกอร์เยือน</label><input id="ag" type="number" min="0" max="20" value="0" class="inp text-center"></div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
          <button id="saveMatch" class="btn-main">✅ บันทึกผล</button>
          <button id="incH" class="btn-s">🏠 +1 เหย้า</button>
          <button id="incA" class="btn-s">🛫 +1 เยือน</button>
          <button id="setDraw" class="btn-s">⚖️ 1–1</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">📜 ประวัติแมตช์</h3>
        <div id="matchLog" class="space-y-2 max-h-80 overflow-y-auto"></div>
      </div>
    </section>

    <!-- Players -->
    <section id="players" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <h3 class="text-center font-bold text-gray-800 mb-4">📝 บันทึกสถิติผู้เล่น</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div><label class="lbl">ทีม</label><select id="selTeamForPlayer" class="sel"></select></div>
          <div><label class="lbl">ผู้เล่น</label><select id="selPlayer" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <button data-s="goals" class="btn-stat btn-s">⚽ ประตู</button>
          <button data-s="assists" class="btn-stat btn-s">🎯 แอสซิสต์</button>
          <button data-s="saves" class="btn-stat btn-s">🥅 เซฟ</button>
          <button data-s="cleanSheets" class="btn-stat btn-s">🛡️ คลีนชีท</button>
          <button data-s="yellowCards" class="btn-stat btn-s">🟨 เหลือง</button>
          <button data-s="redCards" class="btn-stat btn-s">🟥 แดง</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
        <div class="panel"><h4>🏆 ดาวซัลโว</h4><div id="topGoals"></div></div>
        <div class="panel"><h4>🎯 แอสซิสต์</h4><div id="topAssists"></div></div>
        <div class="panel"><h4>🥅 คลีนชีท</h4><div id="topCS"></div></div>
      </div>
    </section>

    <!-- Teams (with logo upload) -->
    <section id="teams" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div><label class="lbl">เลือกทีม</label><select id="selEditTeam" class="sel"></select></div>
          <div><label class="lbl">ชื่อทีม</label><input id="inpTeamName" class="inp" placeholder="ใส่ชื่อทีม"></div>
          <div>
            <label class="lbl">โลโก้ทีม</label>
            <div class="flex items-center gap-3">
              <div id="teamLogoPreviewEdit" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">🏳️</div>
              <input id="teamLogoInputEdit" type="file" accept="image/*" class="hidden">
              <button id="btnChooseTeamLogoEdit" class="btn-s">📷 เลือกรูป</button>
              <button id="btnClearTeamLogoEdit" class="btn-danger">🧹 ลบรูป</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnTeamUpdate" class="btn-main">💾 บันทึกการแก้ไข</button>
          <button id="btnTeamAdd" class="btn-s">➕ เพิ่มทีมใหม่</button>
          <button id="btnTeamDelete" class="btn-danger">🗑️ ลบทีม</button>
        </div>
        <div class="mt-4 p-4 rounded-xl bg-white/70 border">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="lbl">โลโก้ทีมใหม่</label>
              <div class="flex items-center gap-3">
                <div id="teamLogoPreviewNew" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">🏳️</div>
                <input id="teamLogoInputNew" type="file" accept="image/*" class="hidden">
                <button id="btnChooseTeamLogoNew" class="btn-s">📷 เลือกรูป</button>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="lbl">ชื่อทีมใหม่</label>
              <input id="inpTeamNameNew" class="inp" placeholder="ใส่ชื่อทีมใหม่แล้วกด ➕ เพิ่มทีมใหม่">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Roster -->
    <section id="roster" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex items-center gap-2"><span class="font-semibold">เลือกทีม:</span><select id="selRosterTeam" class="sel w-56"></select></div>
        <button id="btnToggleAddPlayer" class="btn-main">➕ เพิ่มนักกีฬา</button>
      </div>
      <div id="addPlayerForm" class="bg-white rounded-2xl shadow p-5 mb-5 hidden">
        <h3 class="text-center font-bold text-gray-800 mb-3">➕ เพิ่มนักกีฬาใหม่</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="lbl">ทีม *</label><select id="npTeam" class="sel"></select></div>
          <div><label class="lbl">ชื่อ-นามสกุล *</label><input id="npName" class="inp"></div>
          <div><label class="lbl">อายุ *</label><input id="npAge" type="number" min="15" max="50" class="inp"></div>
          <div><label class="lbl">วันเกิด</label><input id="npBirth" type="date" class="inp"></div>
          <div><label class="lbl">ตำแหน่ง *</label>
            <select id="npPos" class="sel">
              <option value="">-- เลือกตำแหน่ง --</option>
              <option value="goalkeeper">🥅 ผู้รักษาประตู</option>
              <option value="defender">🛡️ กองหลัง</option>
              <option value="midfielder">⚽ กองกลาง</option>
              <option value="forward">🎯 กองหน้า</option>
            </select>
          </div>
          <div><label class="lbl">เบอร์เสื้อ</label><input id="npNum" type="number" min="1" max="99" class="inp"></div>
          <div><label class="lbl">เบอร์โทรศัพท์</label><input id="npPhone" class="inp" placeholder="081-234-5678"></div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnAddNewPlayer" class="btn-main">✅ เพิ่มนักกีฬา</button>
          <button id="btnClearNewPlayer" class="btn-s">🔄 ล้างฟอร์ม</button>
          <button id="btnCancelNewPlayer" class="btn-danger">❌ ยกเลิก</button>
        </div>
      </div>
      <div id="rosterWrap"></div>
    </section>
  </main>

  <script>
// ===================== Config & Helpers =====================
const STORAGE_KEY = 'football_state_ce_v2_min';
const $   = (s, r=document)=>r.querySelector(s);
const esc = (s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
                            .replaceAll('>','&gt;').replaceAll('"','&quot;')
                            .replaceAll("'","&#039;");
const id  = p=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;

// ===================== State & Persistence =====================
let state = { teams: [] }; // {id,name,logo,members:[]}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
    if(!Array.isArray(state.teams)) state.teams = [];
  } catch { state = { teams: [] }; }
}
function seedIfEmpty(){
  if(state.teams.length) return;
  state.teams = [
    {id:id('team'), name:'Manchester City', logo:'', members:[]},
    {id:id('team'), name:'Arsenal',         logo:'', members:[]}
  ];
  save();
}

// ===================== UI Rendering =====================
function renderTeamSelect(){
  const sel = $('#selEditTeam');
  if(!sel) return;
  sel.innerHTML = '<option value="">-- เลือกทีม --</option>' +
    state.teams.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');
}

function showTeamPreview(team){
  const box = $('#teamLogoPreview');
  if(!box) return;
  if(team?.logo){
    box.innerHTML = `<img src="${team.logo}" class="w-full h-full object-cover" alt="${esc(team.name)}">`;
  } else {
    box.innerHTML = `<span class="text-gray-400">ไม่มี</span>`;
  }
}

// ===================== Logo file handling =====================
let pendingLogoDataURL = ''; // เก็บไฟล์ที่เลือกสำหรับทีมใหม่/แก้ไข

const fileInput = $('#inpTeamLogo');
fileInput?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  if(!f.type.startsWith('image/')) { alert('กรุณาเลือกรูปภาพ'); e.target.value=''; return; }
  if(f.size > 5*1024*1024) { alert('ไฟล์เกิน 5MB'); e.target.value=''; return; }
  const r = new FileReader();
  r.onload = ev => { pendingLogoDataURL = ev.target.result; showTeamPreview({logo: pendingLogoDataURL}); };
  r.onerror = () => alert('อ่านรูปไม่สำเร็จ');
  r.readAsDataURL(f);
});

// ===================== Actions =====================
function addTeam(){
  const name = $('#inpTeamName').value.trim();
  if(!name) return alert('ใส่ชื่อทีม');
  if(state.teams.some(t => t.name === name)) return alert('มีทีมนี้อยู่แล้ว');

  state.teams.push({ id:id('team'), name, logo: pendingLogoDataURL || '', members: [] });
  save();
  renderTeamSelect();

  // reset form
  $('#inpTeamName').value = '';
  if(fileInput) fileInput.value = '';
  pendingLogoDataURL = '';
  showTeamPreview(null);

  alert('✅ เพิ่มทีมใหม่เรียบร้อย');
}

function updateTeam(){
  const teamId = $('#selEditTeam').value;
  const name   = $('#inpTeamName').value.trim();
  if(!teamId) return alert('กรุณาเลือกทีม');
  if(!name)    return alert('ใส่ชื่อทีม');

  const t = state.teams.find(x=>x.id===teamId);
  if(!t) return alert('ไม่พบทีม');

  t.name = name;
  // ถ้ามีเลือกรูปใหม่ในรอบนี้ ให้บันทึกทับ
  if(pendingLogoDataURL) t.logo = pendingLogoDataURL;

  save();
  renderTeamSelect();
  $('#selEditTeam').value = t.id; // คงการเลือก
  showTeamPreview(t);
  if(fileInput) fileInput.value = '';
  pendingLogoDataURL = '';
  alert('💾 บันทึกการแก้ไขเรียบร้อย');
}

function deleteTeam(){
  const teamId = $('#selEditTeam').value;
  if(!teamId) return alert('กรุณาเลือกทีม');
  const t = state.teams.find(x=>x.id===teamId);
  if(!t) return;

  if(!confirm(`ยืนยันลบทีม "${t.name}" ?`)) return;
  state.teams = state.teams.filter(x=>x.id!==teamId);
  save();
  renderTeamSelect();
  $('#inpTeamName').value = '';
  if(fileInput) fileInput.value = '';
  pendingLogoDataURL = '';
  showTeamPreview(null);
  alert('🗑️ ลบทีมเรียบร้อย');
}

// ===================== Wiring =====================
function bind(){
  $('#btnTeamAdd')   ?.addEventListener('click', addTeam);
  $('#btnTeamUpdate')?.addEventListener('click', updateTeam);
  $('#btnTeamDelete')?.addEventListener('click', deleteTeam);

  $('#selEditTeam')?.addEventListener('change', (e)=>{
    const t = state.teams.find(x=>x.id===e.target.value);
    $('#inpTeamName').value = t?.name || '';
    pendingLogoDataURL = ''; // เลือกทีม -> ไม่ใช้รูปชั่วคราวค้าง
    showTeamPreview(t || null);
    if(fileInput) fileInput.value = '';
  });
}

// ===================== Init =====================
function init(){
  load();        // โหลดจาก localStorage
  seedIfEmpty(); // มีค่าแรกเริ่มเพื่อให้เห็น UI ทำงาน
  renderTeamSelect();
  bind();
  showTeamPreview(null);
}
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
