
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบตารางคะแนนฟุตบอล — CE v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme:light} body{font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .page{display:none} .page.active{display:block}
    .btn{background:#f8fafc;border-radius:0.75rem;padding:.6rem .8rem;font-weight:600}
    .btn.active,.btn:hover{background:#e0f2fe}
    .card{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem;text-align:center}
    .card .t{font-size:.85rem;color:#64748b}
    .card .v{font-size:1.5rem;font-weight:800;color:#2563eb}
    .lbl{display:block;font-size:.8rem;font-weight:700;color:#334155;margin-bottom:.25rem}
    .sel,.inp{width:100%;padding:.65rem;border:2px solid #e5e7eb;border-radius:.9rem}
    .btn-main{background:#10b981;color:#fff;font-weight:700;border-radius:.9rem;padding:.6rem 1rem}
    .btn-s{background:#3b82f6;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .btn-danger{background:#ef4444;color:#fff;font-weight:700;border-radius:.9rem;padding:.5rem .9rem}
    .panel{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:1rem}
    table th,table td{padding:.5rem;text-align:center}
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white/90 backdrop-blur shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <div class="text-3xl">⚽</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-gray-800">ระบบตารางคะแนนฟุตบอล — CE v2</h1>
          <p class="text-sm text-gray-600">สัปดาห์ที่
            <button id="wk-" class="px-2 rounded bg-gray-100 hover:bg-gray-200">−</button>
            <span id="wk" class="font-semibold">1</span>
            <button id="wk+" class="px-2 rounded bg-gray-100 hover:bg-gray-200">＋</button>
            | อัปเดต: <span id="now">--:--:--</span>
          </p>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button id="btnSave" class="text-sm bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg">💾 บันทึก</button>
        <button id="btnExport" class="text-sm bg-sky-500 hover:bg-sky-600 text-white px-3 py-1.5 rounded-lg">📤 ส่งออก</button>
        <label class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-lg cursor-pointer">
          📥 นำเข้า<input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnClear" class="text-sm bg-rose-500 hover:bg-rose-600 text-white px-3 py-1.5 rounded-lg">🧹 ล้างข้อมูล</button>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="bg-white shadow">
    <div class="container mx-auto px-4 py-2 grid grid-cols-3 md:grid-cols-6 gap-2">
      <button class="tab btn active" data-p="dashboard">🏠 หน้าหลัก</button>
      <button class="tab btn" data-p="table">🏆 ตารางคะแนน</button>
      <button class="tab btn" data-p="match">⚽ บันทึกผล</button>
      <button class="tab btn" data-p="players">👤 สถิติผู้เล่น</button>
      <button class="tab btn" data-p="teams">⚙️ จัดการทีม</button>
      <button class="tab btn" data-p="roster">📋 รายชื่อนักกีฬา</button>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Dashboard -->
    <section id="dashboard" class="page active">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card"><div class="t">ทีมทั้งหมด</div><div id="statTeams" class="v"></div></div>
        <div class="card"><div class="t">แมตช์ทั้งหมด</div><div id="statMatches" class="v"></div></div>
        <div class="card"><div class="t">สมาชิกทั้งหมด</div><div id="statMembers" class="v"></div></div>
        <div class="card"><div class="t">สัปดาห์ปัจจุบัน</div><div id="statWeek" class="v"></div></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">🥇 Top Teams</h3>
        <div id="topTeams" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">🗓️ แมตช์ล่าสุด</h3>
        <div id="recentMatches" class="space-y-2"></div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-bold text-gray-800 mb-3">📊 กิจกรรมล่าสุด</h3>
        <div id="activities" class="space-y-2 max-h-64 overflow-y-auto" aria-live="polite"></div>
      </div>
    </section>

    <!-- Table -->
    <section id="table" class="page">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 text-center text-xl font-bold">JAKHONG LEAGUE 3</div>
        <div class="p-3 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-700 text-white">
              <tr><th>#</th><th class="text-left">ทีม</th><th>แข่ง</th><th>ชนะ</th><th>เสมอ</th><th>แพ้</th><th>ได้</th><th>เสีย</th><th>+/-</th><th>คะแนน</th><th>ฟอร์ม</th></tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Match -->
    <section id="match" class="page">
      <div class="bg-white rounded-2xl shadow p-5 max-w-3xl mx-auto space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="lbl">ทีมเหย้า</label><select id="selHome" class="sel"></select></div>
          <div><label class="lbl">ทีมเยือน</label><select id="selAway" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="lbl">สกอร์เหย้า</label><input id="hg" type="number" min="0" max="20" value="0" class="inp text-center"></div>
          <div><label class="lbl">สกอร์เยือน</label><input id="ag" type="number" min="0" max="20" value="0" class="inp text-center"></div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
          <button id="saveMatch" class="btn-main">✅ บันทึกผล</button>
          <button id="incH" class="btn-s">🏠 +1 เหย้า</button>
          <button id="incA" class="btn-s">🛫 +1 เยือน</button>
          <button id="setDraw" class="btn-s">⚖️ 1–1</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5 mt-5">
        <h3 class="font-bold text-gray-800 mb-3">📜 ประวัติแมตช์</h3>
        <div id="matchLog" class="space-y-2 max-h-80 overflow-y-auto"></div>
      </div>
    </section>

    <!-- Players -->
    <section id="players" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <h3 class="text-center font-bold text-gray-800 mb-4">📝 บันทึกสถิติผู้เล่น</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <div><label class="lbl">ทีม</label><select id="selTeamForPlayer" class="sel"></select></div>
          <div><label class="lbl">ผู้เล่น</label><select id="selPlayer" class="sel"></select></div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <button data-s="goals" class="btn-stat btn-s">⚽ ประตู</button>
          <button data-s="assists" class="btn-stat btn-s">🎯 แอสซิสต์</button>
          <button data-s="saves" class="btn-stat btn-s">🥅 เซฟ</button>
          <button data-s="cleanSheets" class="btn-stat btn-s">🛡️ คลีนชีท</button>
          <button data-s="yellowCards" class="btn-stat btn-s">🟨 เหลือง</button>
          <button data-s="redCards" class="btn-stat btn-s">🟥 แดง</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
        <div class="panel"><h4>🏆 ดาวซัลโว</h4><div id="topGoals"></div></div>
        <div class="panel"><h4>🎯 แอสซิสต์</h4><div id="topAssists"></div></div>
        <div class="panel"><h4>🥅 คลีนชีท</h4><div id="topCS"></div></div>
      </div>
    </section>

    <!-- Teams (with logo upload) -->
    <section id="teams" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-5">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <div><label class="lbl">เลือกทีม</label><select id="selEditTeam" class="sel"></select></div>
          <div><label class="lbl">ชื่อทีม</label><input id="inpTeamName" class="inp" placeholder="ใส่ชื่อทีม"></div>
          <div>
            <label class="lbl">โลโก้ทีม</label>
            <div class="flex items-center gap-3">
              <div id="teamLogoPreviewEdit" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">🏳️</div>
              <input id="teamLogoInputEdit" type="file" accept="image/*" class="hidden">
              <button id="btnChooseTeamLogoEdit" class="btn-s">📷 เลือกรูป</button>
              <button id="btnClearTeamLogoEdit" class="btn-danger">🧹 ลบรูป</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnTeamUpdate" class="btn-main">💾 บันทึกการแก้ไข</button>
          <button id="btnTeamAdd" class="btn-s">➕ เพิ่มทีมใหม่</button>
          <button id="btnTeamDelete" class="btn-danger">🗑️ ลบทีม</button>
        </div>
        <div class="mt-4 p-4 rounded-xl bg-white/70 border">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="lbl">โลโก้ทีมใหม่</label>
              <div class="flex items-center gap-3">
                <div id="teamLogoPreviewNew" class="w-14 h-14 rounded-full overflow-hidden border-2 border-gray-200 bg-gradient-to-b from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">🏳️</div>
                <input id="teamLogoInputNew" type="file" accept="image/*" class="hidden">
                <button id="btnChooseTeamLogoNew" class="btn-s">📷 เลือกรูป</button>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="lbl">ชื่อทีมใหม่</label>
              <input id="inpTeamNameNew" class="inp" placeholder="ใส่ชื่อทีมใหม่แล้วกด ➕ เพิ่มทีมใหม่">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Roster -->
    <section id="roster" class="page">
      <div class="bg-white rounded-2xl shadow p-5 mb-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex items-center gap-2"><span class="font-semibold">เลือกทีม:</span><select id="selRosterTeam" class="sel w-56"></select></div>
        <button id="btnToggleAddPlayer" class="btn-main">➕ เพิ่มนักกีฬา</button>
      </div>
      <div id="addPlayerForm" class="bg-white rounded-2xl shadow p-5 mb-5 hidden">
        <h3 class="text-center font-bold text-gray-800 mb-3">➕ เพิ่มนักกีฬาใหม่</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="lbl">ทีม *</label><select id="npTeam" class="sel"></select></div>
          <div><label class="lbl">ชื่อ-นามสกุล *</label><input id="npName" class="inp"></div>
          <div><label class="lbl">อายุ *</label><input id="npAge" type="number" min="15" max="50" class="inp"></div>
          <div><label class="lbl">วันเกิด</label><input id="npBirth" type="date" class="inp"></div>
          <div><label class="lbl">ตำแหน่ง *</label>
            <select id="npPos" class="sel">
              <option value="">-- เลือกตำแหน่ง --</option>
              <option value="goalkeeper">🥅 ผู้รักษาประตู</option>
              <option value="defender">🛡️ กองหลัง</option>
              <option value="midfielder">⚽ กองกลาง</option>
              <option value="forward">🎯 กองหน้า</option>
            </select>
          </div>
          <div><label class="lbl">เบอร์เสื้อ</label><input id="npNum" type="number" min="1" max="99" class="inp"></div>
          <div><label class="lbl">เบอร์โทรศัพท์</label><input id="npPhone" class="inp" placeholder="081-234-5678"></div>
        </div>
        <div class="flex gap-2 justify-center mt-3">
          <button id="btnAddNewPlayer" class="btn-main">✅ เพิ่มนักกีฬา</button>
          <button id="btnClearNewPlayer" class="btn-s">🔄 ล้างฟอร์ม</button>
          <button id="btnCancelNewPlayer" class="btn-danger">❌ ยกเลิก</button>
        </div>
      </div>
      <div id="rosterWrap"></div>
    </section>
  </main>

  <script>
  // ---------- Helpers ----------
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const esc = (s='')=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll(\"'\",\"&#039;\");
  const pad = n=>String(n).padStart(2,'0');
  const fmtTime = d=>\`\${pad(d.getHours())}:\${pad(d.getMinutes())}:\${pad(d.getSeconds())}\`;
  const id = p=>\`\${p}_\${Date.now().toString(36)}_\${Math.random().toString(36).slice(2,8)}\`;
  const debounce = (fn,ms=300)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  // ---------- State ----------
  const STORAGE_KEY = 'football_state_ce_v2';
  const SCHEMA_VERSION = 2;
  let state = {
    schemaVersion: SCHEMA_VERSION,
    currentWeek: 1,
    teams: [], /* {id,name,logo,members:[{id,name,age,position,number,phone,birthdate,photo,joinDate}], table fields computed } */
    matches: [], /* {id,homeId,awayId,hg,ag,week,date} */
    playerStats: {}, /* {[playerId]:{teamId,goals,assists,saves,cleanSheets,yellowCards,redCards}} */
    activities: []
  };

  // ---------- Seed (first run) ----------
  function seed(){
    const t = (name,members=[])=>({id:id('team'),name,logo:'',played:0,wins:0,draws:0,losses:0,points:0,goalsFor:0,goalsAgainst:0,form:[],members});
    const p = (name,age,position,number,phone,birthdate)=>({id:id('player'),name,age,position,number,phone,photo:'',joinDate:'1/1/2567',birthdate});
    state.teams = [
      t('แมนเชสเตอร์ ซิตี้',[p('เออร์ลิง ฮาลันด์',23,'forward',9,'081-234-5678','2000-07-21'),p('เควิน เดอ บรอยน์',32,'midfielder',17,'081-234-5679','1991-06-28')]),
      t('อาร์เซนอล',[p('บูคาโย ซากา',22,'forward',7,'081-234-5680','2001-09-05'),p('มาร์ติน เอเดการ์ด',25,'midfielder',8,'081-234-5681','1998-08-17')]),
      t('ลิเวอร์พูล'), t('เชลซี'), t('แมนเชสเตอร์ ยูไนเต็ด'), t('ท็อตแน่ม')
    ];
  }

  // ---------- Persistence ----------
  function save(){
    try{localStorage.setItem(STORAGE_KEY, JSON.stringify(state));}
    catch(e){console.error(e); alert('ไม่สามารถบันทึกลงเครื่องได้ (พื้นที่เต็ม?)');}
  }
  const saveDebounced = debounce(save,250);

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){seed(); return;}
    try{
      const data = JSON.parse(raw);
      if(!data.schemaVersion){
        seed();
      }else{ state = data; }
    }catch(e){console.error(e); seed();}
  }

  // ---------- Derive ----------
  const teamMap = ()=>{
    const m = new Map(); state.teams.forEach(t=>m.set(t.id,t)); return m;
  };

  function recompute(){
    state.teams.forEach(t=>Object.assign(t,{played:0,wins:0,draws:0,losses:0,points:0,goalsFor:0,goalsAgainst:0,form:[]}));
    const map = teamMap();
    state.matches.slice().reverse().forEach(m=>{
      const H = map.get(m.homeId), A = map.get(m.awayId); if(!H||!A) return;
      H.played++; A.played++; H.goalsFor+=m.hg; H.goalsAgainst+=m.ag; A.goalsFor+=m.ag; A.goalsAgainst+=m.hg;
      if(m.hg>m.ag){H.wins++;H.points+=3;H.form.push('W');A.losses++;A.form.push('L');}
      else if(m.hg<m.ag){A.wins++;A.points+=3;A.form.push('W');H.losses++;H.form.push('L');}
      else{H.draws++;A.draws++;H.points++;A.points++;H.form.push('D');A.form.push('D');}
      H.form=H.form.slice(-10); A.form=A.form.slice(-10);
    });
  }

  const sortTeams = (a,b)=> b.points-a.points || (b.goalsFor-b.goalsAgainst)-(a.goalsFor-a.goalsAgainst) || b.goalsFor-a.goalsFor || b.wins-a.wins || a.name.localeCompare(b.name,'th');

  // ---------- Render ----------
  function setActive(page){ $$('.page').forEach(p=>p.classList.remove('active')); $('#'+page).classList.add('active'); $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.p===page)); }
  function renderHeader(){ $('#wk').textContent = state.currentWeek; $('#statWeek').textContent = state.currentWeek; }
  function renderStats(){
    $('#statTeams').textContent = state.teams.length;
    $('#statMatches').textContent = state.matches.length;
    $('#statMembers').textContent = state.teams.reduce((s,t)=>s+(t.members?.length||0),0);
  }
  function renderTopTeams(){
    const box = $('#topTeams');
    const data = [...state.teams].sort(sortTeams).slice(0,3);
    box.innerHTML = data.length? data.map((t,i)=>`<div class="bg-white border rounded-xl p-4 text-center">
      <div class="text-2xl mb-1">${['🥇','🥈','🥉'][i]||''}</div>
      <div class="font-bold">${esc(t.name)}</div>
      <div class="text-blue-600 text-xl font-extrabold">${t.points}</div>
      <div class="text-xs text-gray-500 mt-1">${t.wins} ชนะ • ${t.draws} เสมอ • ${t.losses} แพ้</div>
    </div>`).join('') : '<div class="text-gray-500 text-center">ยังไม่มีการแข่งขัน</div>';
  }
  function renderRecentMatches(){
    const box = $('#recentMatches');
    if(!state.matches.length){ box.innerHTML='<p class="text-gray-500 text-center">ยังไม่มีแมตช์</p>'; return; }
    const map = teamMap();
    box.innerHTML = state.matches.slice(0,6).map(m=>{
      const H=map.get(m.homeId)?.name||'—', A=map.get(m.awayId)?.name||'—';
      const tag = m.hg>m.ag?'✅ เหย้าชนะ': m.hg<m.ag?'✅ เยือนชนะ':'⚖️ เสมอ';
      return `<div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
        <div class="font-semibold truncate">${esc(H)} <span class="text-gray-500">vs</span> ${esc(A)}</div>
        <div class="flex items-center gap-3"><span class="text-sm bg-blue-600 text-white px-2 py-0.5 rounded">${m.hg}–${m.ag}</span><span class="text-xs text-gray-600">${tag}</span></div>
      </div>`
    }).join('');
  }
  function renderActivities(){
    const box = $('#activities');
    box.innerHTML = state.activities.length? state.activities.slice(0,10).map(a=>`<div class="bg-gray-50 p-2 rounded border-l-4 border-blue-500 text-sm">${esc(a)}</div>`).join('') : '<p class="text-gray-500 text-center">ยังไม่มีกิจกรรม</p>';
  }
  function renderTable(){
    const tb = $('#tbl'); tb.innerHTML='';
    [...state.teams].sort(sortTeams).forEach((t,i)=>{
      const gd = t.goalsFor - t.goalsAgainst, gdC = gd>0?'text-green-600':gd<0?'text-rose-600':'text-gray-600';
      tb.insertAdjacentHTML('beforeend', `<tr class="hover:bg-blue-50"><td class="font-bold ${i<3?'text-blue-700':''}">${i+1}</td>
        <td class="text-left font-semibold">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full overflow-hidden border">
              ${t.logo ? `<img src="${t.logo}" alt="${esc(t.name)}" class="w-full h-full object-cover">`
                       : `<div class="w-full h-full bg-blue-600 text-white flex items-center justify-center text-xs">${esc(t.name.charAt(0))}</div>`}
            </div>
            <span>${esc(t.name)}</span>
          </div>
        </td><td>${t.played}</td><td>${t.wins}</td><td>${t.draws}</td><td>${t.losses}</td>
        <td>${t.goalsFor}</td><td>${t.goalsAgainst}</td><td class="${gdC}">${gd>0?'+':''}${gd}</td>
        <td><span class="bg-blue-600 text-white px-2 py-0.5 rounded font-bold">${t.points}</span></td>
        <td class="text-xs">${t.form.slice(-5).join(' ')||'-'}</td></tr>`);
    });
  }
  function fillTeamSelect(sel, opts={withAll:false,withCount:false}){
    sel.innerHTML = opts.withAll? '<option value="all">👥 ทุกทีม</option>' : '<option value="">-- เลือกทีม --</option>';
    state.teams.forEach(t=> sel.insertAdjacentHTML('beforeend', `<option value="${t.id}">${esc(t.name)}${opts.withCount?` (${t.members?.length||0} คน)`:''}</option>`));
  }
  function renderSelects(){
    fillTeamSelect($('#selHome')); fillTeamSelect($('#selAway'));
    fillTeamSelect($('#selTeamForPlayer'));
    const et=$('#selEditTeam'); et.innerHTML='<option value="">-- เลือกทีม --</option>'; state.teams.forEach(t=>et.insertAdjacentHTML('beforeend',`<option value="${t.id}">${esc(t.name)}</option>`));
    fillTeamSelect($('#selMemberTeam'));
    fillTeamSelect($('#selRosterTeam'),{withAll:true,withCount:true});
    fillTeamSelect($('#npTeam'));
  }
  function renderPlayerSelect(){
    const teamId = $('#selTeamForPlayer').value; const sel = $('#selPlayer'); sel.innerHTML='<option value="">-- เลือกผู้เล่น --</option>';
    if(!teamId) return; const team = state.teams.find(t=>t.id===teamId); if(!team||!team.members?.length){ sel.innerHTML='<option value="">-- ทีมนี้ยังไม่มีนักกีฬา --</option>'; return; }
    team.members.forEach(m=> sel.insertAdjacentHTML('beforeend', `<option value="${m.id}">${esc(m.name)}${m.number?` (#${m.number})`:''}</option>`));
  }
  function renderMatchLog(){
    const box = $('#matchLog'); if(!state.matches.length){box.innerHTML='<p class="text-gray-500 text-center">ยังไม่มีแมตช์</p>';return;}
    const map = teamMap();
    box.innerHTML = state.matches.map(m=>`<div class="bg-gray-50 p-3 rounded flex items-center justify-between">
      <div class="font-semibold truncate">${esc(map.get(m.homeId)?.name||'')} <span class="text-gray-500">vs</span> ${esc(map.get(m.awayId)?.name||'')}</div>
      <div class="flex items-center gap-2"><span class="bg-blue-600 text-white text-sm px-2 py-0.5 rounded">${m.hg}–${m.ag}</span>
        <button class="btn-danger text-xs" data-del-match="${m.id}">ลบ</button></div>
    </div>`).join('');
  }
  function topList(key){
    const entries = Object.entries(state.playerStats).filter(([_,s])=> (s[key]||0)>0).sort((a,b)=> (b[1][key]||0)-(a[1][key]||0)).slice(0,5);
    if(!entries.length) return '<p class="text-gray-500 text-center">ยังไม่มีข้อมูล</p>';
    const nameById = pid=>{for(const t of state.teams){const p=t.members?.find(x=>x.id===pid); if(p) return {name:p.name, team:t.name};} return {name:'',team:''};};
    return entries.map(([pid,s],i)=>{const info=nameById(pid); return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded border-l-4 border-blue-500">
      <div class="flex items-center gap-3"><span class="text-lg font-bold text-gray-600">${i+1}</span><div>
        <div class="font-semibold">${esc(info.name)}</div><div class="text-xs text-gray-600">${esc(info.team)}</div></div></div>
      <div class="text-right"><div class="text-lg font-bold text-blue-600">${s[key]||0}</div></div></div>`}).join('');
  }
  function renderPlayerBlocks(){
    $('#topGoals').innerHTML = topList('goals');
    $('#topAssists').innerHTML = topList('assists');
    $('#topCS').innerHTML = topList('cleanSheets');
  }
  function renderMembers(){
    const teamId = $('#selMemberTeam')?.value; const wrap=$('#memberForm'); if(!wrap) return;
    if(!teamId){wrap.classList.add('hidden'); return;} wrap.classList.remove('hidden');
    const team = state.teams.find(t=>t.id===teamId); const list = $('#membersList'); $('#mCount').textContent = team.members?.length||0;
    if(!team.members?.length){ list.innerHTML='<p class="text-gray-500 text-center">ยังไม่มีสมาชิก</p>'; return; }
    list.innerHTML = team.members.map(m=>`<div class="bg-white rounded-xl shadow p-3 border">
      <div class="text-center">
        <h4 class="font-bold">${esc(m.name)} ${m.number?`<span class='text-xs bg-blue-500 text-white rounded px-1 ml-1'>#${m.number}</span>`:''}</h4>
        <div class="text-sm text-gray-600">อายุ: ${m.age} ปี • ${esc(m.position)}</div>
        <div class="mt-2"><button class="btn-danger text-xs" data-del-member="${teamId}|${m.id}">🗑️ ลบ</button></div>
      </div>
    </div>`).join('');
  }
  function renderRoster(){
    const sel = $('#selRosterTeam'); const teamId = sel?.value || 'all'; const box = $('#rosterWrap'); if(!box) return;
    const card = m=>`<div class="bg-gradient-to-b from-white to-gray-50 rounded-xl shadow p-4 border"><div class="text-center">
      <h4 class="text-sm font-bold">${esc(m.name)}</h4><div class="text-xs text-gray-600">อายุ: ${m.age} ปี</div></div></div>`;
    let all=[];
    if(teamId==='all'){ state.teams.forEach(t=> (t.members||[]).forEach(m=>all.push({...m,team:t.name}))); }
    else { const t=state.teams.find(x=>x.id===teamId); (t?.members||[]).forEach(m=>all.push({...m,team:t.name})); }
    if(!all.length){ box.innerHTML=`<div class='bg-white rounded-2xl shadow p-8 text-center'><div class='text-6xl mb-3'>👤</div><h3 class='font-bold'>ยังไม่มีนักกีฬา</h3></div>`; return; }
    if(teamId==='all'){
      const groups={}; all.forEach(p=> (groups[p.team] ||= []).push(p));
      box.innerHTML = Object.entries(groups).map(([team,players])=>`<div class="bg-white rounded-2xl shadow p-5 mb-4">
        <h3 class="font-bold mb-3">${esc(team)} <span class="text-sm text-gray-500">${players.length} คน</span></h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${players.map(card).join('')}</div>
      </div>`).join('');
    }else{
      box.innerHTML = `<div class="bg-white rounded-2xl shadow p-5"><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${all.map(card).join('')}</div></div>`;
    }
  }

  // ---------- Actions ----------
  const addActivity = msg=>{ state.activities.unshift(msg); state.activities=state.activities.slice(0,120); };

  function recordMatch(){
    const homeId=$('#selHome').value, awayId=$('#selAway').value; const hg=+$('#hg').value||0, ag=+$('#ag').value||0;
    if(!homeId||!awayId) return alert('กรุณาเลือกทีม'); if(homeId===awayId) return alert('ทีมเหย้าและทีมเยือนต้องไม่ซ้ำกัน'); if(hg<0||ag<0) return alert('สกอร์ต้องเป็นเลข 0 ขึ้นไป');
    state.matches.unshift({id:id('match'),homeId,awayId,hg,ag,week:state.currentWeek,date:new Date().toISOString()});
    const map=teamMap(); addActivity(\`\${new Date().toLocaleString('th-TH')}: บันทึกผล \${map.get(homeId)?.name} \${hg}-\${ag} \${map.get(awayId)?.name} [สัปดาห์ \${state.currentWeek}]\`);
    recompute(); renderAll(); saveDebounced(); $('#selHome').value=''; $('#selAway').value=''; $('#hg').value=0; $('#ag').value=0;
  }

  function addPlayerStat(key){
    const teamId=$('#selTeamForPlayer').value; const pid=$('#selPlayer').value; if(!teamId) return alert('กรุณาเลือกทีม'); if(!pid) return alert('กรุณาเลือกผู้เล่น');
    state.playerStats[pid] ||= {teamId,goals:0,assists:0,saves:0,cleanSheets:0,yellowCards:0,redCards:0};
    state.playerStats[pid][key] = (state.playerStats[pid][key]||0)+1;
    const name = (()=>{for(const t of state.teams){const p=t.members?.find(x=>x.id===pid); if(p) return \`\${p.name}\`;} return 'ผู้เล่น';})();
    const tname = state.teams.find(t=>t.id===teamId)?.name||'';
    addActivity(\`\${new Date().toLocaleString('th-TH')}: อัปเดตสถิติ \${name} (\${tname}) — \${key}\`);
    renderPlayerBlocks(); renderStats(); saveDebounced(); $('#selPlayer').value='';
  }

  function applyTeamEdit(){
    const idTeam=$('#selEditTeam').value; const name=$('#inpTeamName').value.trim(); if(!idTeam) return alert('เลือกทีม'); if(!name) return alert('ใส่ชื่อทีม');
    const t = state.teams.find(x=>x.id===idTeam); const old=t.name; t.name=name;
    const f = $('#teamLogoInputEdit');
    const done= (withLogo)=>{ addActivity(\`แก้ไขทีม "\${old}" เป็น "\${name}"\${withLogo?' และอัปเดตโลโก้':''}\`); renderSelects(); renderStats(); renderTable(); renderHeader(); saveDebounced(); };
    if(f && f.files && f.files[0]){ const file=f.files[0]; if(file.size>5*1024*1024) return alert('รูปใหญ่เกิน 5MB'); const r=new FileReader(); r.onload=e=>{ t.logo=e.target.result; updateTeamLogoPreview('edit', t.logo, t.name); f.value=''; done(true); }; r.onerror=()=>alert('อ่านรูปไม่สำเร็จ'); r.readAsDataURL(file); }
    else done(false);
  }

  function addTeamWithLogo(){
    const name=$('#inpTeamNameNew')?.value.trim() || $('#inpTeamName')?.value.trim(); if(!name) return alert('ใส่ชื่อทีม'); if(state.teams.some(t=>t.name===name)) return alert('มีทีมนี้แล้ว');
    const f=$('#teamLogoInputNew');
    const doAdd=(logo)=>{ state.teams.push({id:id('team'),name,logo:logo||'',played:0,wins:0,draws:0,losses:0,points:0,goalsFor:0,goalsAgainst:0,form:[],members:[]}); addActivity(\`เพิ่มทีมใหม่ "\${name}"\`); $('#inpTeamNameNew').value=''; $('#inpTeamName').value=''; if(f) f.value=''; updateTeamLogoPreview('new', null, name); renderSelects(); renderStats(); renderTable(); saveDebounced(); };
    if(f && f.files && f.files[0]){ const file=f.files[0]; if(file.size>5*1024*1024) return alert('รูปใหญ่เกิน 5MB'); const r=new FileReader(); r.onload=e=>doAdd(e.target.result); r.onerror=()=>alert('อ่านรูปไม่สำเร็จ'); r.readAsDataURL(file); }
    else doAdd('');
  }

  function deleteTeam(){
    const idTeam=$('#selEditTeam').value; if(!idTeam) return alert('เลือกทีม'); const t=state.teams.find(x=>x.id===idTeam);
    if(!confirm(\`ยืนยันลบทีม "\${t.name}" ?\`)) return;
    state.matches = state.matches.filter(m=>m.homeId!==idTeam && m.awayId!==idTeam);
    state.teams = state.teams.filter(x=>x.id!==idTeam);
    recompute(); addActivity(\`ลบทีม "\${t.name}"\`); renderSelects(); renderStats(); renderTable(); renderMatchLog(); saveDebounced();
  }

  function addMember(){
    const teamId=$('#selMemberTeam')?.value; const name=$('#memberName')?.value?.trim(); const age=+($('#memberAge')?.value||0); const pos=$('#memberPos')?.value;
    if(!teamId||!name||!age||!pos) return alert('กรอกข้อมูลให้ครบ'); const team=state.teams.find(t=>t.id===teamId); team.members ||= [];
    team.members.push({id:id('player'),name,age,position:pos,number:null,phone:'',photo:'',joinDate:new Date().toLocaleDateString('th-TH'),birthdate:''});
    addActivity(\`เพิ่มสมาชิก "\${name}" ในทีม "\${team.name}"\`); if($('#memberName')) $('#memberName').value=''; if($('#memberAge')) $('#memberAge').value=''; if($('#memberPos')) $('#memberPos').value=''; renderMembers(); renderStats(); saveDebounced();
  }
  function deleteMember(teamId, pid){
    const t=state.teams.find(x=>x.id===teamId); const m=t.members.find(x=>x.id===pid); if(!m) return; if(!confirm(\`ลบ "\${m.name}" ?\`)) return;
    t.members = t.members.filter(x=>x.id!==pid); addActivity(\`ลบสมาชิก "\${m.name}" ออกจากทีม "\${t.name}"\`);
    renderMembers(); renderStats(); saveDebounced();
  }

  function toggleAddPlayerForm(){ const f=$('#addPlayerForm'); const b=$('#btnToggleAddPlayer'); if(!f||!b) return; if(f.classList.contains('hidden')){ f.classList.remove('hidden'); b.textContent='❌ ยกเลิก'; } else { f.classList.add('hidden'); b.textContent='➕ เพิ่มนักกีฬา'; clearNP(); } }
  const clearNP=()=>{$('#npTeam')&&($('#npTeam').value=''); $('#npName')&&($('#npName').value=''); $('#npAge')&&($('#npAge').value=''); $('#npBirth')&&($('#npBirth').value=''); $('#npPos')&&($('#npPos').value=''); $('#npNum')&&($('#npNum').value=''); $('#npPhone')&&($('#npPhone').value=''); };
  function addNewPlayer(){
    const teamId=$('#npTeam').value, name=$('#npName').value.trim(), age=+$('#npAge').value||0, birth=$('#npBirth').value, pos=$('#npPos').value, num=$('#npNum').value, phone=$('#npPhone').value.trim();
    if(!teamId||!name||!age||!pos) return alert('กรอกข้อมูลให้ครบ'); const t=state.teams.find(x=>x.id===teamId); const number=num?+num:null;
    if(number && t.members?.some(m=>m.number===number)) return alert(\`เบอร์เสื้อ \${number} ซ้ำในทีมนี้\`);
    const player={id:id('player'),name,age,birthdate:birth||'',position:pos,number,phone,photo:'',joinDate:new Date().toLocaleDateString('th-TH')};
    t.members ||= []; t.members.push(player);
    addActivity(\`เพิ่มนักกีฬา "\${name}" (\${birth||'—'}) ในทีม "\${t.name}"\`);
    renderRoster(); renderSelects(); renderStats(); saveDebounced(); clearNP(); toggleAddPlayerForm();
  }

  // --- Logo helpers ---
  function handleTeamLogoFile(e, mode){
    const file=e.target.files?.[0]; if(!file) return; if(file.size>5*1024*1024){ alert('ไฟล์ใหญ่เกิน 5MB'); e.target.value=''; return; }
    const r=new FileReader(); r.onload=ev=> updateTeamLogoPreview(mode, ev.target.result); r.onerror=()=>alert('อ่านรูปไม่สำเร็จ'); r.readAsDataURL(file);
  }
  function updateTeamLogoPreview(mode, dataURL, name=''){
    const el = mode==='edit'? $('#teamLogoPreviewEdit') : $('#teamLogoPreviewNew');
    if(!el) return; if(!dataURL){ el.innerHTML='🏳️'; return; }
    el.innerHTML = `<img src="${dataURL}" alt="${esc(name||'team')}" class="w-full h-full object-cover">`;
  }

  // ---------- Wiring ----------
  function renderAll(){ renderHeader(); renderStats(); renderTopTeams(); renderRecentMatches(); renderActivities(); renderTable(); renderSelects(); renderPlayerBlocks(); renderRoster(); renderMatchLog(); }

  function bind(){
    $$('.tab').forEach(b=> b.addEventListener('click',()=> setActive(b.dataset.p)) );
    $('#wk+').addEventListener('click',()=>{state.currentWeek++; renderHeader(); saveDebounced();});
    $('#wk-').addEventListener('click',()=>{state.currentWeek=Math.max(1,state.currentWeek-1); renderHeader(); saveDebounced();});
    $('#btnSave').addEventListener('click',()=>{save(); alert('บันทึกลงเครื่องเรียบร้อย');});
    $('#btnExport').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='league-data-v2.json'; a.click(); URL.revokeObjectURL(a.href); });
    $('#importFile').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); if(!d.schemaVersion) throw new Error('bad'); state=d; recompute(); renderAll(); save(); alert('นำเข้าข้อมูลเรียบร้อย'); }catch{ alert('ไฟล์ไม่ถูกต้อง'); } }; r.readAsText(f); e.target.value=''; });
    $('#btnClear').addEventListener('click',()=>{ if(confirm('ล้างข้อมูลทั้งหมด?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

    $('#selTeamForPlayer').addEventListener('change', renderPlayerSelect);
    $$('#players .btn-stat').forEach(b=> b.addEventListener('click',()=> addPlayerStat(b.dataset.s)) );

    $('#saveMatch').addEventListener('click', recordMatch);
    $('#incH').addEventListener('click',()=> $('#hg').value = (+$('#hg').value||0)+1 );
    $('#incA').addEventListener('click',()=> $('#ag').value = (+$('#ag').value||0)+1 );
    $('#setDraw').addEventListener('click',()=> { $('#hg').value=1; $('#ag').value=1; });

    $('#selEditTeam').addEventListener('change', e=>{ const t=state.teams.find(x=>x.id===e.target.value); $('#inpTeamName').value=t?.name||''; updateTeamLogoPreview('edit', t?.logo||'', t?.name||''); });
    $('#btnTeamUpdate').addEventListener('click', applyTeamEdit);
    $('#btnTeamAdd').addEventListener('click', addTeamWithLogo);
    $('#btnTeamDelete').addEventListener('click', deleteTeam);
    $('#btnChooseTeamLogoEdit').addEventListener('click', ()=> $('#teamLogoInputEdit').click());
    $('#btnChooseTeamLogoNew').addEventListener('click', ()=> $('#teamLogoInputNew').click());
    $('#teamLogoInputEdit').addEventListener('change', e=> handleTeamLogoFile(e,'edit'));
    $('#teamLogoInputNew').addEventListener('change', e=> handleTeamLogoFile(e,'new'));
    $('#btnClearTeamLogoEdit').addEventListener('click', ()=>{ const idTeam=$('#selEditTeam').value; const t=state.teams.find(x=>x.id===idTeam); if(!t) return; t.logo=''; updateTeamLogoPreview('edit','', t.name); saveDebounced(); });

    $('#btnToggleAddPlayer').addEventListener('click', toggleAddPlayerForm);
    $('#btnAddNewPlayer').addEventListener('click', addNewPlayer);
    $('#btnClearNewPlayer').addEventListener('click', clearNP);
    $('#btnCancelNewPlayer').addEventListener('click', toggleAddPlayerForm);

    // delegated deletes
    $('#matchLog').addEventListener('click', e=>{ const id = e.target?.dataset?.delMatch; if(!id) return; if(!confirm('ลบแมตช์นี้?')) return; state.matches = state.matches.filter(x=>x.id!==id); addActivity('ลบแมตช์'); recompute(); renderMatchLog(); renderTable(); renderRecentMatches(); saveDebounced(); });
    $('#membersList').addEventListener('click', e=>{ const key=e.target?.dataset?.delMember; if(!key) return; const [tid,pid]=key.split('|'); deleteMember(tid,pid); });
  }

  function tick(){ $('#now').textContent = fmtTime(new Date()); requestAnimationFrame(()=>setTimeout(tick,1000)); }

  // ---------- Init ----------
  function init(){ load(); recompute(); bind(); renderAll(); tick(); }
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
